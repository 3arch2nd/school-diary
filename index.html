<script>
        const PRO_BACKEND_URL = "https://script.google.com/macros/s/AKfycbxn2nB0ZNXwXSdfx4-XVUWTD3Z_GCb_L2_SkhLyiKu5qrZrpwGTLM9Y4BhQRbveIk4o8Q/exec"; 
        const IS_GAS_ENV = window.location.hostname.includes('script.google.com');
        const IS_PRO_MODE = !IS_GAS_ENV && PRO_BACKEND_URL !== "";
        
        let currentMode = 'subject'; let mobileMode = 'subject'; let selectedStudentName = null; let viewTabMode = 'subject';
        let studentList = []; let subjectList = ["êµ­ì–´", "ìˆ˜í•™", "ì‚¬íšŒ", "ê³¼í•™", "ì˜ì–´", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ "];
        let customItems = []; let currentCustomItem = null;
        let targetSubjectToDelete = null; let aiPersona = ""; let aiJobQueue = []; let totalAiJobs = 0;
        let curYear = new Date().getFullYear(); let curMonth = new Date().getMonth();
        let selectedDate = formatDateYMD(new Date());
        let bmList = []; let currentBmFilter = null; let bmTags = ["ìˆ˜ì—…", "ì—…ë¬´", "ìë£Œ", "ì˜ìƒ"];
        let selectedBmTags = [];
        let memoList = []; let memoMode = 'cal'; let curMemoMonth = new Date().getMonth();
        let curMemoYear = new Date().getFullYear(); let selectedMemoDate = formatDateYMD(new Date());
        let calendarEvents = []; let homeQuickLinks = [];
        let musicPlaylist = [];
        let attendanceCache = [];
        let customRecordCache = []; 

        window.onload = () => { 
            checkLock(); 
            document.getElementById('rDate').valueAsDate = new Date();
            document.getElementById('mobDate').valueAsDate = new Date(); 
            initEnvironment(); 
        };

        function checkCaps(e) { 
            const caps = e.getModifierState && e.getModifierState("CapsLock"); 
            document.getElementById('lockMsg').innerText = caps ? "ğŸ’¡ Caps Lock ì¼œì§" : "ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (í•œ/ì˜ í™•ì¸)"; 
            if(e.keyCode===13) unlockApp();
        }

        function checkLock() { 
            let isUnlocked = false;
            try { 
                isUnlocked = sessionStorage.getItem('isUnlocked') === 'true' || localStorage.getItem('isAutoUnlocked') === 'true'; 
            } catch(e) {}
            
            if(isUnlocked) { 
                document.getElementById('lockScreen').style.display='none';
                loadAllData(); 
            } 
        }

        function unlockApp() { 
            const pw = document.getElementById('lockInput').value;
            if(pw === 'ekdms320') { 
                try { 
                    sessionStorage.setItem('isUnlocked', 'true');
                    localStorage.setItem('isAutoUnlocked', 'true');
                } catch(e) {}
                document.getElementById('lockScreen').style.display='none'; 
                loadAllData();
            } else { 
                alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
                document.getElementById('lockInput').value=''; 
            } 
        }

        function relockApp() {
            try { 
                sessionStorage.setItem('isUnlocked', 'false'); 
                localStorage.setItem('isAutoUnlocked', 'false'); 
            } catch(e) {}
            location.reload();
        }

        async function loadAllData() { 
            // ìˆœì°¨ì  ë¡œë”© (ë°ì´í„° ì˜ì¡´ì„± ê³ ë ¤)
            loadStudents();
            renderSubjectTags(); 
            renderBmTags(); 
            loadFiles(); 
            loadHomeData(); 
            loadMusicData(); 
            loadCustomItems();
            
            // ì¼ì •ê³¼ ì¶œì„ ë°ì´í„° ë³‘ë ¬ ë¡œë“œ
            await Promise.all([loadGoogleEvents(), loadAttendanceForDots()]);
            
            // ë°ì´í„° ë¡œë“œ í›„ í™”ë©´ ê°±ì‹  ê°•ì œ ì‹¤í–‰
            renderHomeToDo(); 
            renderCalendar(); 
            showDailyView(new Date().getDate());
            
            if(customItems.length > 0) refreshCustomView();
        }

        // ==========================================
        // [í•µì‹¬ ìˆ˜ì •] ì¼ì • ë¡œë“œ í›„ í™”ë©´ ê°±ì‹  ì—°ê²°
        // ==========================================
        async function loadGoogleEvents() { 
            calendarEvents = await sendRequest('get_events') || [];
            
            // ë°ì´í„°ê°€ ë„ì°©í–ˆìœ¼ë‹ˆ, ì¦‰ì‹œ í™”ë©´(í™ˆ/ë‹¬ë ¥)ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
            renderHomeToDo();           // í™ˆ í™”ë©´ 'ì˜¤ëŠ˜ì˜ í•  ì¼' ê°±ì‹ 
            updateTodayScheduleInCal(); // ë‹¬ë ¥ íƒ­ 'ì˜¤ëŠ˜ ì¼ì •' ê°±ì‹ 
            renderCalendar();           // ë‹¬ë ¥ì— ì  ì°ê¸° ê°±ì‹ 
        }

        // [í•µì‹¬ ìˆ˜ì •] í™ˆ í™”ë©´ 'ì˜¤ëŠ˜ì˜ í•  ì¼' (ëª¨ë°”ì¼/PC ID ëª¨ë‘ ì²˜ë¦¬)
        function renderHomeToDo() { 
            const todayStr = formatDateYMD(new Date()); 
            const todaysEvents = calendarEvents.filter(e => e.date === todayStr);
            
            const html = todaysEvents.length > 0 
                ? todaysEvents.map(e => `â€¢ ${e.title}`).join('<br>') 
                : "ì¼ì • ì—†ìŒ";

            // ëª¨ë°”ì¼ìš© ì—…ë°ì´íŠ¸
            const elMobile = document.getElementById('homeToDoListMobile');
            if(elMobile) elMobile.innerHTML = html;

            // PCìš© ì—…ë°ì´íŠ¸
            const elPC = document.getElementById('homeToDoListPC');
            if(elPC) elPC.innerHTML = html;
        }

        // [í•µì‹¬ ìˆ˜ì •] ë‹¬ë ¥ íƒ­ í•˜ë‹¨ 'ì˜¤ëŠ˜ ì¼ì •' (ID: todayTodoListCal)
        function updateTodayScheduleInCal() { 
            const todayStr = formatDateYMD(new Date());
            const todaysEvents = calendarEvents.filter(e => e.date === todayStr);
            
            const html = todaysEvents.length > 0 
                ? todaysEvents.map(e => `â€¢ ${e.title}`).join('<br>') 
                : "ì¼ì • ì—†ìŒ";
                
            const elCal = document.getElementById('todayTodoListCal');
            if(elCal) elCal.innerHTML = html;
        }

        // Global Overlay Logic
        function closeAllOverlays() {
            document.getElementById('floatMenu').classList.remove('show');
            document.getElementById('lockFloatBtn').classList.remove('show');
            document.getElementById('musicPanel').classList.remove('show');
            document.getElementById('globalOverlay').classList.remove('show');
        }
        function toggleFloatMenu() { 
            const m = document.getElementById('floatMenu');
            const l = document.getElementById('lockFloatBtn');
            m.classList.toggle('show'); 
            l.classList.toggle('show');
            
            if(m.classList.contains('show')) document.getElementById('globalOverlay').classList.add('show');
            else document.getElementById('globalOverlay').classList.remove('show');
        }
        function changeSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            closeAllOverlays();
            
            document.querySelectorAll('.nav-tabs .nav-item').forEach(e => e.classList.remove('active'));
            const nav = document.querySelector(`.nav-tabs .nav-item[onclick="changeSection('${id}')"]`);
            if(nav) nav.classList.add('active');

            if(id === 'neis') {
                const typeSelect = document.getElementById('neisType');
                if(typeSelect) { typeSelect.value = 'subject'; toggleNeisType(); }
            }

            if(id === 'bookmarks') loadBookmarks(); 
            else if(id === 'calendar') { 
                renderCalendar(); 
                showDailyView(new Date(selectedDate).getDate()); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ ìœ ì§€
            } 
            else if(id === 'memo') loadMemos();
        }
        function reqConfirm(msg, callback) { document.getElementById('confirmMsg').innerText = msg;
            document.getElementById('confirmModal').classList.add('open'); document.getElementById('btnConfirmYes').onclick = () => { document.getElementById('confirmModal').classList.remove('open'); callback(); }; }

        // [MUSIC PLAYER]
        function toggleMusicPanel() { 
            const p = document.getElementById('musicPanel');
            p.classList.toggle('show');
            if(p.classList.contains('show')) document.getElementById('globalOverlay').classList.add('show');
            else document.getElementById('globalOverlay').classList.remove('show');
        }
        async function loadMusicData() {
            const data = await sendRequest('manage_music', {mode: 'get'});
            musicPlaylist = data || [];
            if(musicPlaylist.length === 0) musicPlaylist = [{name: "Lo-fi Study", id: "jfKfPfyJRdk"}];
            renderMusicList();
        }
        function renderMusicList() {
            const c = document.getElementById('musicList');
            c.innerHTML = '';
            musicPlaylist.forEach((m, i) => {
                const d = document.createElement('div'); d.className = 'mp-item';
                d.innerHTML = `<span onclick="playMusic('${m.id}', '${m.name}')">${m.name}</span> <span style="color:#e74c3c;" onclick="removeMusic(${i})">x</span>`;
                c.appendChild(d);
            });
            const addDiv = document.createElement('div'); addDiv.className = 'mp-add';
            addDiv.innerHTML = `<input type="text" id="newMusicUrl" placeholder="ìœ íŠœë¸Œ ë§í¬"><button class="btn-sm active" onclick="addMusic()">+</button>`;
            c.appendChild(addDiv);
        }
        function playMusic(id, name) { 
            document.getElementById('musicIframe').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            document.getElementById('musicCurrentTitle').innerText = "ğŸµ " + name;
        }
        async function addMusic() {
            const url = document.getElementById('newMusicUrl').value;
            let id = ""; if (url.includes("v=")) id = url.split("v=")[1].split("&")[0]; else if (url.includes("youtu.be/")) id = url.split("youtu.be/")[1];
            if (id) {
                const name = prompt("ë…¸ë˜ ì œëª©:", "ìƒˆ ë…¸ë˜");
                musicPlaylist.push({name: name||"ë…¸ë˜", id: id});
                renderMusicList();
                await sendRequest('manage_music', {mode:'save', playlist: musicPlaylist});
                document.getElementById('newMusicUrl').value = "";
            } else alert("ìœ íš¨í•œ ë§í¬ í•„ìš”");
        }
        async function removeMusic(idx) {
            musicPlaylist.splice(idx, 1);
            renderMusicList();
            await sendRequest('manage_music', {mode:'save', playlist: musicPlaylist});
        }

        // [AI Status Bar]
        function updateAiStatus(current, total, name) {
            const bar = document.getElementById('aiStatusBar');
            const txt = document.getElementById('aiStatusText');
            if(current > total) bar.classList.remove('show');
            else { bar.classList.add('show');
            txt.innerText = `[âœ¨ ì‘ì—… ì¤‘] ${current}/${total} : ${name} ì²˜ë¦¬ ì¤‘...`;
            }
        }

        // [HOME Logic]
        async function loadHomeData() { 
            const d = await sendRequest('get_home_data');
            if (d) { 
                if (d.image) { 
                    let finalUrl = d.image;
                    if(finalUrl.includes('drive.google.com') && finalUrl.includes('/view')) {
                         const idMatch = finalUrl.match(/\/d\/(.+?)\//);
                         if(idMatch && idMatch[1]) {
                             finalUrl = `https://lh3.googleusercontent.com/d/${idMatch[1]}`;
                         }
                    }
                    document.getElementById('homeMainImg').src = finalUrl; 
                    document.getElementById('homeMainImg').style.display = 'block'; 
                    document.querySelector('.home-image-msg').style.display = 'none'; 
                } 
                homeQuickLinks = d.links || []; 
                renderQuickLinks(); 
            } 
        }
        function renderQuickLinks() { const g=document.getElementById('quickLinkGrid');
            g.innerHTML=''; homeQuickLinks.slice(0,5).forEach((l,i)=>{ const d=document.createElement('div'); d.className='quick-link-item'; d.innerHTML=`<div class="ql-emoji">${l.emoji}</div><div class="ql-name">${l.name}</div>`; d.onclick=()=>window.open(l.url,'_blank'); d.oncontextmenu=(e)=>{e.preventDefault();reqConfirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',()=>{homeQuickLinks.splice(i,1);saveHomeLinks();})}; g.appendChild(d); }); if(homeQuickLinks.length<5){ const a=document.createElement('div'); a.className='quick-link-item'; a.innerHTML='<div style="font-size:2rem; color:var(--primary)">+</div><div class="ql-name">ì¶”ê°€</div>';
            a.onclick=()=>document.getElementById('addLinkModal').classList.add('open'); g.appendChild(a); } }
        function confirmAddLink() { const u=document.getElementById('qlUrl').value; if(!u) return;
            homeQuickLinks.push({emoji:document.getElementById('qlEmoji').value||'ğŸ”—', name:document.getElementById('qlName').value||'ë§í¬', url:u}); saveHomeLinks(); document.getElementById('addLinkModal').classList.remove('open'); document.getElementById('qlUrl').value=''; }
        async function saveHomeLinks() { renderQuickLinks();
            await sendRequest('save_home_config', {key:"QuickLinks", value:JSON.stringify(homeQuickLinks)}); }

        async function uploadHomeImage(inp) {
            if (inp.files.length === 0) return;
            const f = inp.files[0];
            const r = new FileReader();
            r.onload = async function(e) {
                const base64Data = e.target.result;
                const imgTag = document.getElementById('homeMainImg');
                imgTag.src = base64Data;
                imgTag.style.display = 'block';
                document.querySelector('.home-image-msg').style.display = 'none';
                showToast("â˜ï¸ ì„œë²„ì— ì´ë¯¸ì§€ ì €ì¥ ì¤‘...");
                try {
                    const rawData = base64Data.split(',')[1];
                    const res = await sendRequest('upload_file', {
                        name: "home_img_" + Date.now(), 
                        mimeType: f.type,
                        data: rawData
                    });
                    if (res && res.url) {
                        await sendRequest('save_home_config', { key: "MainImage", value: res.url });
                        showToast("âœ… ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ!");
                    }
                } catch (err) { console.error(err); showToast("âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨ (í™”ë©´ì—” ìœ ì§€ë¨)"); }
            };
            r.readAsDataURL(f);
            inp.value = ''; 
        }
        
        // Quick Record
        async function saveHomeQuickRecord(source) { 
            let inputId = 'homeQuickInput';
            if(source === 'mobile') inputId = 'homeQuickInputMobile';
            const t=document.getElementById(inputId).value.trim(); 
            if(!t) return; showToast("âœ¨ ì²˜ë¦¬ ì¤‘");
            try{ 
                const a=await sendRequest('call_ai',{prompt:`ì…ë ¥:"${t}". ê·œì¹™: ì´ë¦„/ê³¼ëª©/ë‚´ìš© ë¶„ë¦¬. JSONì¶œë ¥:{"name":"ì´ë¦„","type":"ê³¼ëª©","text":"ë‚´ìš©"}`});
                const j=JSON.parse(a.text.replace(/```json/g,"").replace(/```/g,"")); 
                await sendRequest('save_record',{date:formatDateYMD(new Date()), name:j.name, type:j.type, text:j.text, check:"ì—†ìŒ"}); 
                document.getElementById(inputId).value=""; 
                showToast("ì €ì¥ ì™„ë£Œ");
            } catch(e){showToast("ì‹¤íŒ¨");} 
        }

        const da=document.getElementById('homeImgArea');
        da.addEventListener('dragover',e=>{e.preventDefault();da.style.background='#eee';}); da.addEventListener('drop',e=>{e.preventDefault();da.style.background='#fafafa'; if(e.dataTransfer.files.length>0){document.getElementById('homeImgInput').files=e.dataTransfer.files; uploadHomeImage(document.getElementById('homeImgInput'));}});
        
        // [Record Logic - Normal & Custom]
        function setMode(m) { 
            currentMode=m;
            document.getElementById('btnSubject').className=m==='subject'?'btn-sm active':'btn-sm inactive'; 
            document.getElementById('btnBehavior').className=m==='behavior'?'btn-sm active':'btn-sm inactive'; 
            document.getElementById('btnCustom').className=m==='custom'?'btn-sm active':'btn-sm inactive'; 
            
            if (m === 'custom') {
                document.getElementById('normalModeOptions').style.display = 'none';
                document.getElementById('customModeOptions').style.display = 'block';
                document.getElementById('normalRecordView').style.display = 'none';
                document.getElementById('customRecordView').style.display = 'flex'; 
                renderCustomItems();
            } else {
                document.getElementById('normalModeOptions').style.display = 'block';
                document.getElementById('customModeOptions').style.display = 'none';
                document.getElementById('normalRecordView').style.display = 'block'; 
                document.getElementById('customRecordView').style.display = 'none';
                document.getElementById('subjectArea').style.display=m==='subject'?'block':'none';
                document.getElementById('checkHeader').style.visibility=m==='subject'?'visible':'hidden'; 
                renderRecordList();
            }
        }
        
        // [Mobile Record Mode Logic]
        function setMobileMode(m) {
            mobileMode = m;
            document.getElementById('mobBtnSub').className = m === 'subject' ? 'btn-sm active' : 'btn-sm inactive';
            document.getElementById('mobBtnBeh').className = m === 'behavior' ? 'btn-sm active' : 'btn-sm inactive';
            document.getElementById('mobBtnCust').className = m === 'custom' ? 'btn-sm active' : 'btn-sm inactive';
            if(m === 'custom') {
                document.getElementById('mobViewQuick').style.display = 'none';
                document.getElementById('mobViewCustom').style.display = 'flex';
                const s = document.getElementById('mobCustomSelect');
                s.innerHTML = '';
                loadCustomItems().then(() => {
                    customItems.forEach((item, idx) => {
                       const opt = document.createElement('option'); opt.value = idx; opt.innerText = item.name;
                       s.appendChild(opt);
                    });
                    if(customItems.length > 0) { refreshCustomView().then(renderMobileCustomList); }
                });
            } else {
                document.getElementById('mobViewQuick').style.display = 'flex';
                document.getElementById('mobViewCustom').style.display = 'none';
                const tip = document.getElementById('mobQuickTip');
                if(m === 'subject') tip.innerText = "ì˜ˆ: ê¹€ì² ìˆ˜/ìˆ˜í•™/ë°œí‘œ ì˜í•¨";
                else tip.innerText = "ì˜ˆ: ê¹€ì² ìˆ˜/ì¹œêµ¬ë¥¼ ì˜ ë„ì™€ì¤Œ";
            }
        }

        // [Custom & Mobile Custom]
        function renderMobileCustomList() {
             const idx = document.getElementById('mobCustomSelect').value;
             const container = document.getElementById('mobCustomList');
             container.innerHTML = '';
             if(idx === null || idx === undefined) return;
             
             const itemDef = customItems[idx];
             const targetDate = document.getElementById('mobDate').value;

             studentList.forEach(st => {
                 const row = document.createElement('div'); row.className = 'student-row';
                 const record = customRecordCache.find(r => r.date === targetDate && r.item === itemDef.name && r.name === st.name);
                 let savedVal = record ? record.value : "";
                 let inputHtml = '';
                 if(itemDef.type === 'check') {
                     const chk = savedVal === 'O' ? 'checked' : '';
                     inputHtml = `<input type="checkbox" class="mob-cust-val" style="width:20px; height:20px; margin:0;" ${chk}>`;
                 }
                 else if(itemDef.type === 'switch') {
                     const chk = savedVal === 'ON' ? 'checked' : '';
                     inputHtml = `<label class="switch"><input type="checkbox" class="mob-cust-val" ${chk}><span class="slider"></span></label>`;
                 }
                 else if(itemDef.type === 'select') {
                     inputHtml = `<select class="mob-cust-val" style="margin:0;"><option value="">-</option><option ${savedVal==='ìƒ'?'selected':''}>ìƒ</option><option ${savedVal==='ì¤‘'?'selected':''}>ì¤‘</option><option ${savedVal==='í•˜'?'selected':''}>í•˜</option></select>`;
                 }
                 row.innerHTML = `<div class="st-name" style="width:80px; font-weight:bold;">${st.name}</div><div style="flex:1;"></div>${inputHtml}`;
                 container.appendChild(row);
             });
        }
        async function saveMobileCustom() {
             const idx = document.getElementById('mobCustomSelect').value;
             if(idx === null) return;
             const itemDef = customItems[idx];
             const rows = document.querySelectorAll('#mobCustomList .student-row');
             const data = [];
             const date = document.getElementById('mobDate').value;
             rows.forEach(row => {
                 const name = row.querySelector('.st-name').innerText;
                 const el = row.querySelector('.mob-cust-val');
                 let val = "";
                 if(itemDef.type === 'select') val = el.value;
                 else val = el.checked ? (itemDef.type==='check'?'O':'ON') : '';
                 if(val) data.push({date: date, item: itemDef.name, name: name, value: val});
             });
             if(data.length > 0) {
                 await sendRequest('custom_record', {mode:'save', data: data});
                 showToast("ì €ì¥ ì™„ë£Œ");
                 refreshCustomView(); 
             } else { showToast("ì„ íƒëœ ë‚´ìš© ì—†ìŒ"); }
        }
        async function loadCustomItems() { customItems = await sendRequest('manage_custom_items', {mode:'get'}) || []; }
        function renderCustomItems() {
            const list = document.getElementById('customItemsList');
            list.innerHTML = '';
            customItems.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = `custom-item-row ${currentCustomItem===idx ? 'active':''}`;
                div.innerText = item.name;
                div.onclick = () => { currentCustomItem = idx; renderCustomItems(); refreshCustomView(); };
                list.appendChild(div);
            });
        }
        function openCustomItemModal() { document.getElementById('customItemModal').classList.add('open'); }
        async function addCustomItem() {
            const name = document.getElementById('ciName').value;
            const type = document.getElementById('ciType').value;
            if(name) {
                customItems.push({name, type, options: ""});
                await sendRequest('manage_custom_items', {mode:'save', items: customItems});
                document.getElementById('customItemModal').classList.remove('open');
                loadCustomItems().then(renderCustomItems);
            }
        }
        async function refreshCustomView() {
            const chartArea = document.getElementById('customStatsChart'); 
            if(chartArea) chartArea.innerHTML = '<div style="text-align:center; padding:20px;">ë¡œë”©<span class="loading-anim"></span></div>';
            const pcList = document.getElementById('customCheckList');
            if(pcList) pcList.innerHTML = '<div style="text-align:center; padding:20px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘<span class="loading-anim"></span></div>';
            
            const allData = await sendRequest('custom_record', {mode:'get'});
            customRecordCache = allData || [];
            if(currentCustomItem !== null) { renderCustomCheckList(); renderCustomStats(); }
        }
        function renderCustomCheckList() {
            const container = document.getElementById('customCheckList');
            container.innerHTML = '';
            if (currentCustomItem === null) return;
            const itemDef = customItems[currentCustomItem];
            const today = document.getElementById('rDate').value;
            studentList.forEach(st => {
                const row = document.createElement('div'); row.className = 'quick-row'; 
                const record = customRecordCache.find(r => r.date === today && r.item === itemDef.name && r.name === st.name);
                let savedVal = record ? record.value : "";
                let inputHtml = '';
                if(itemDef.type === 'check') {
                    const chk = savedVal === 'O' ? 'checked' : '';
                    inputHtml = `<input type="checkbox" class="cust-val" style="width:24px; height:24px; margin:0;" ${chk}>`;
                }
                else if(itemDef.type === 'switch') {
                    const chk = savedVal === 'ON' ? 'checked' : '';
                    inputHtml = `<label class="switch"><input type="checkbox" class="cust-val" ${chk}><span class="slider"></span></label>`;
                }
                else if(itemDef.type === 'select') {
                    inputHtml = `<select class="cust-val" style="margin:0;"><option value="">-</option><option ${savedVal==='ìƒ'?'selected':''}>ìƒ</option><option ${savedVal==='ì¤‘'?'selected':''}>ì¤‘</option><option ${savedVal==='í•˜'?'selected':''}>í•˜</option></select>`;
                }
                row.innerHTML = `<div class="quick-name">${st.name}</div><div class="quick-input">${inputHtml}</div>`;
                container.appendChild(row);
            });
        }
        async function saveCustomData() {
            if(currentCustomItem === null) return;
            const itemDef = customItems[currentCustomItem];
            const rows = document.querySelectorAll('#customCheckList .quick-row');
            const data = [];
            const today = document.getElementById('rDate').value;
            rows.forEach(row => {
                const name = row.querySelector('.quick-name').innerText;
                const el = row.querySelector('.cust-val');
                let val = "";
                if(itemDef.type === 'select') val = el.value;
                else val = el.checked ? (itemDef.type==='check'?'O':'ON') : '';
                if(val) data.push({date: today, item: itemDef.name, name: name, value: val});
            });
            if(data.length > 0) {
                await sendRequest('custom_record', {mode:'save', data: data});
                showToast("ì €ì¥ ì™„ë£Œ");
                refreshCustomView(); 
            } else { showToast("ì„ íƒëœ ë‚´ìš© ì—†ìŒ"); }
        }
        async function renderCustomStats() {
            if(currentCustomItem === null) return;
            const chartArea = document.getElementById('customStatsChart'); 
            const allData = customRecordCache;
            const itemDef = customItems[currentCustomItem];
            const range = document.getElementById('statsRangeSelect').value;
            const today = new Date();
            let startDate = new Date(today); let endDate = new Date(today);
            if (range === 'month') { startDate.setDate(1); endDate.setMonth(endDate.getMonth() + 1); endDate.setDate(0); } 
            else if (range === 's1') { startDate = new Date(today.getFullYear(), 2, 1); endDate = new Date(today.getFullYear(), 7, 31); } 
            else if (range === 's2') { startDate = new Date(today.getFullYear(), 8, 1); endDate = new Date(today.getFullYear() + 1, 1, 28); } 
            else if (range === 'year') { startDate = new Date(today.getFullYear(), 2, 1); endDate = new Date(today.getFullYear() + 1, 1, 28); }
            const startStr = formatDateYMD(startDate); const endStr = formatDateYMD(endDate);
            const filteredData = allData.filter(d => {
                if (d.item !== itemDef.name) return false;
                if (range === 'today') return d.date === formatDateYMD(today);
                return d.date >= startStr && d.date <= endStr;
            });
            const studentStats = studentList.map(st => {
                const count = filteredData.filter(d => d.name === st.name).length;
                return { id: st.id, name: st.name, count: count };
            });
            const maxVal = Math.max(...studentStats.map(s => s.count)) || 1; 
            const total = studentStats.length; const oneThird = Math.ceil(total / 3);
            chartArea.innerHTML = `<div class="chart-bars-area" id="barsContainer"></div>`;
            const barsContainer = document.getElementById('barsContainer');
            studentStats.forEach((st, i) => {
                const bar = document.createElement('div');
                bar.className = 'stat-bar';
                let heightPct = 0;
                if (st.count > 0) { heightPct = 10 + ((st.count / maxVal) * 90); }
                bar.style.height = `${heightPct}%`;
                let alignClass = "";
                if (i < oneThird) alignClass = "left-align"; 
                else if (i >= total - oneThird) alignClass = "right-align";
                bar.innerHTML = `<div class="tooltip ${alignClass}">${st.id}. ${st.name} (${st.count}íšŒ)</div>`;
                barsContainer.appendChild(bar);
            });
            if (studentStats.every(s => s.count === 0)) { barsContainer.innerHTML = '<div style="position:absolute; width:100%; text-align:center; top:50%; color:#aaa;">ë°ì´í„° ì—†ìŒ</div>'; }
        }

        function renderSubjectTags() { 
            const c=document.getElementById('subjectTags');
            c.innerHTML=''; 
            subjectList.forEach(s=>{ 
                const t=document.createElement('div'); t.className='tag'; t.innerHTML=`${s} <span class="x-btn">x</span>`; 
                t.querySelector('.x-btn').onclick = (e) => openDelSub(s, e);
                t.onclick=(e)=>{if(e.target.classList.contains('x-btn'))return; selectSub(t);}; 
                if(s==="êµ­ì–´") t.classList.add('selected'); c.appendChild(t); 
            });
            const addBtn = document.createElement('div'); addBtn.className = 'tag tag-add'; addBtn.innerText = '+'; addBtn.onclick = openSubjectModal;
            c.appendChild(addBtn);
            updateSubjectFilterOptions(); updateNeisSubjectOptions();
        }
        function selectSub(el) { if(el.classList.contains('selected')) {el.classList.remove('selected');} else {document.querySelectorAll('#subjectTags .tag').forEach(t=>t.classList.remove('selected'));
            el.classList.add('selected');} }
        function openDelSub(s,e) { e.stopPropagation(); targetSubjectToDelete=s; document.getElementById('deleteSubjectModal').classList.add('open'); }
        async function confirmDeleteSubject() { await sendRequest('delete_subject',{subject:targetSubjectToDelete}); subjectList=subjectList.filter(s=>s!==targetSubjectToDelete); renderSubjectTags(); document.getElementById('deleteSubjectModal').classList.remove('open'); }
        async function confirmAddSubject() { const n=document.getElementById('newSubjectName').value.trim(); if(n && !subjectList.includes(n)) { await sendRequest('add_subject',{subject:n});
            subjectList.push(n); renderSubjectTags(); closeSubjectModal(); } }
        function openSubjectModal() { document.getElementById('newSubjectName').value=''; document.getElementById('subjectModal').classList.add('open'); }
        function closeSubjectModal() { document.getElementById('subjectModal').classList.remove('open'); }
        
        function renderRecordList() {
             const l=document.getElementById('recordList'); l.innerHTML='';
             studentList.forEach(st=>{
                 const r=document.createElement('div'); r.className='student-row'; 
                 let chk = currentMode === 'subject' 
                    ? `<div class="st-check-group"><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div></div>`
                    : '';
                 r.innerHTML=`<div class="st-name">${st.name}</div><input type="text" class="st-input" id="input_${st.id}" placeholder="ë‚´ìš©">${chk}`;
                 l.appendChild(r);
             });
        }
        function toggleCheck(el) { const p=el.parentElement; const w=el.classList.contains('checked'); p.querySelectorAll('.check-circle').forEach(c=>c.classList.remove('checked')); if(!w) el.classList.add('checked'); }
        
        async function saveData() {
            const inputs = document.querySelectorAll('.st-input'); 
            const isAI = document.getElementById('aiToggle').checked;
            
            let targetType = "í–‰ë™";
            if(currentMode === 'subject') { 
                const selTag = document.querySelector('#subjectTags .tag.selected'); 
                if(!selTag) { showToast("ê³¼ëª© ì„ íƒ í•„ìš”"); return; } 
                targetType = selTag.innerText.split(' ')[0].trim(); 
            }
            
            showStatusBar("ğŸ’¾ ì €ì¥ ì¤€ë¹„ ì¤‘...");
            let itemsToSave = [];
            
            inputs.forEach(input => {
                const text = input.value.trim(); 
                const row = input.closest('.student-row'); 
                const rawName = row.querySelector('.st-name').innerText;
                const name = rawName.includes('.') ? rawName.split('.')[1].trim() : rawName.trim();
                let checkVal = "ì—†ìŒ";
                if(currentMode === 'subject') { 
                    const checks = row.querySelectorAll('.check-circle'); 
                    if(checks[0].classList.contains('checked')) checkVal = "ë§¤ìš°ì˜í•¨"; 
                    else if(checks[1].classList.contains('checked')) checkVal = "ì˜í•¨"; 
                    else if(checks[2].classList.contains('checked')) checkVal = "ë³´í†µ"; 
                    else if(checks[3].classList.contains('checked')) checkVal = "ë…¸ë ¥ìš”í•¨"; 
                }
                if (text.length > 0 || checkVal !== "ì—†ìŒ") itemsToSave.push({ input, name, text, checkVal });
            });
            
            if (itemsToSave.length === 0) { showToast("ì €ì¥í•  ë‚´ìš© ì—†ìŒ"); hideStatusBar(); return; }
            
            inputs.forEach(el => el.value = ''); 
            document.querySelectorAll('.check-circle').forEach(el => el.classList.remove('checked')); 

            let savedCount = 0;
            for (const item of itemsToSave) {
                let period = document.getElementById('rPeriod').value; 
                const topic = document.getElementById('rTopic').value.trim(); 
                let periodPrefix = period ? `[${period}]` : "";
                
                let rawBody = item.text;
                if(topic) rawBody = `[${topic}] ${item.text}`;
                if(item.text.length === 0 && topic) rawBody = `[${topic}] í™œë™ì— ì°¸ì—¬í•¨`;
                rawBody = `${periodPrefix} ${rawBody}`.trim();
                
                updateStatusText(`ğŸ’¾ ì €ì¥ ì¤‘... [${item.name}] (${savedCount + 1}/${itemsToSave.length})`);
                const res = await sendRequest('save_record', { 
                    date: document.getElementById('rDate').value, name: item.name, type: targetType, text: rawBody, check: item.checkVal 
                });
                savedCount++;
                if (isAI && res && res.rowNum) {
                    aiJobQueue.push({ 
                        rowNum: res.rowNum, type: targetType, topic: topic, text: item.text, check: item.checkVal, name: item.name, periodPrefix: periodPrefix 
                    });
                }
            }
            if(isAI && aiJobQueue.length > 0) {
                showToast(`ì €ì¥ ì™„ë£Œ. AI ë³€í™˜ ì‹œì‘ (${aiJobQueue.length}ê±´)`);
                processNextAiJob(); 
            } else {
                hideStatusBar();
                showToast("ì €ì¥ ì™„ë£Œ");
            }
        }

        async function processNextAiJob() {
            if (aiJobQueue.length === 0) { 
                isAiQueueRunning = false; 
                hideStatusBar();
                showToast("âœ¨ ëª¨ë“  AI ë³€í™˜ ì™„ë£Œ!");
                return; 
            }
            isAiQueueRunning = true; 
            const job = aiJobQueue[0];
            showStatusBar(`âœ¨ AI ë‹¤ë“¬ëŠ” ì¤‘... [${job.name}] (ëŒ€ê¸°: ${aiJobQueue.length}ê±´)`);
            const prompt = `ì—­í• : ì´ˆë“±í•™êµ êµì‚¬. ì‘ì—…: ìƒí™œê¸°ë¡ë¶€ ê¸°ì¬ìš© í‰ì–´ í•œ ë¬¸ì¥ ì‘ì„±. ì…ë ¥ì •ë³´: [ì£¼ì œ: ${job.topic || 'ì—†ìŒ'}], [í™œë™ë‚´ìš©: ${job.text || 'ì—†ìŒ'}], [í‰ê°€: ${job.check}].
                [ì‘ì„± ì›ì¹™] 1. ì£¼ì œì™€ í™œë™ë‚´ìš©, í‰ê°€ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ëŠ” **í•˜ë‚˜ì˜ ë¬¸ì¥**ìœ¼ë¡œ ë§Œë“œì„¸ìš”. 2. '[ì£¼ì œ]' ì²˜ëŸ¼ ëŒ€ê´„í˜¸ë¥¼ ì ˆëŒ€ ì“°ì§€ ë§ê³ , ë¬¸ë§¥ ì†ì— ë…¹ì—¬ë‚´ì„¸ìš”. 3. **êµµê²Œ(ë³¼ë“œ)**, "ë”°ì˜´í‘œ" ê¸ˆì§€. 4. ë¬¸ì¥ì€ ë°˜ë“œì‹œ '~í•¨' ë˜ëŠ” '~ìŒ'ìœ¼ë¡œ ëª…ì‚¬í˜• ì¢…ê²°. 5. ì„±ì·¨ ìˆ˜ì¤€(${job.check}) ë°˜ì˜. 6. í˜ë¥´ì†Œë‚˜: ${aiPersona}`;
            try {
                const aiData = await sendRequest('call_ai', { prompt });
                if (aiData && aiData.text) {
                    let finalBody = aiData.text.replace(/['"\[\]]/g, "").replace(/\*\*/g, "").trim();
                    if(job.periodPrefix) finalBody = `${job.periodPrefix} ${finalBody}`;
                    await sendRequest('update_record_row', { type: job.type, rowNum: job.rowNum, text: finalBody });
                }
            } catch (e) { console.error("AI Error:", e); }
            aiJobQueue.shift(); 
            processNextAiJob();
        }

        async function loadAttendanceForDots() {
            const data = await sendRequest('get_attendance');
            attendanceCache = data || [];
        }

        function showStatusBar(msg) {
            const bar = document.getElementById('aiStatusBar');
            const txt = document.getElementById('aiStatusText');
            if(bar && txt) { txt.innerText = msg; bar.classList.add('show'); }
        }
        function updateStatusText(msg) {
            const txt = document.getElementById('aiStatusText');
            if(txt) txt.innerText = msg;
        }
        function hideStatusBar() {
            const bar = document.getElementById('aiStatusBar');
            if(bar) bar.classList.remove('show');
        }
    </script>
</body>
</html>
