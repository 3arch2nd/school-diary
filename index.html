<!DOCTYPE html>
<html lang="ko">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì«‘ì•Œìˆ˜ì²© Pro (Personal)</title>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        /* [ê¸°ë³¸ í…Œë§ˆ] */
        :root {
            --bg-main: #f2f8fc;
            --card-bg: #FFFFFF;
            --primary-light: #9fcde8; --primary: #6ab0cf; --primary-dark: #35667a;
            --text-main: #2c3e50; --text-sub: #7f8c8d; --border-color: #e3eff5;
            --success: #27ae60; --danger: #e74c3c;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Gowun Dodum', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-main); color: var(--text-main); font-size: 16px; line-height: 1.5; overflow-y: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */ height: 100vh; }
        
        /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1dce5; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b0c0ce; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; height: 100%; display: flex; flex-direction: column; }
        header { text-align: center; margin-bottom: 15px; flex-shrink: 0; }
        h1 { color: var(--primary-dark); font-size: 1.6rem; font-weight: bold; letter-spacing: -0.5px; }

        /* ì ê¸ˆ í™”ë©´ */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-main); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #lockCard { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; width: 320px; }
        #lockInput { font-size: 1.2rem; text-align: center; margin-bottom: 10px; letter-spacing: 2px; }
        .lock-info { font-size: 0.8rem; color: var(--text-sub); margin-bottom: 20px; min-height: 1.2em; }

        /* íƒ­ ë©”ë‰´ */
        .nav-tabs { display: flex; background: var(--card-bg); border-radius: 8px; margin-bottom: 15px; padding: 4px; border: 1px solid var(--border-color); flex-shrink: 0; }
        .nav-item { flex: 1; text-align: center; padding: 12px; cursor: pointer; color: var(--text-sub); border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .nav-item.active { color: var(--primary-dark); background-color: #eaf6fc; }

        /* ë ˆì´ì•„ì›ƒ ê³µí†µ */
        .pc-only { display: block; height: 100%; }
        .mobile-only { display: none; }
        
        .section { display: none; height: 100%; flex-grow: 1; overflow: hidden; }
        .section.active { display: block; animation: fadeIn 0.2s; }
        
        .split-container { display: flex; gap: 20px; align-items: stretch; height: calc(100vh - 160px); }
        /* [ë¹„ìœ¨ ê³ ì •] ì™¼ìª½ ë„ˆë¹„ 320px ê³ ì •, ì¤„ì–´ë“¤ì§€ ì•ŠìŒ */
        .split-left { width: 320px; min-width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; }
        .split-right { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; overflow-y: auto; padding-right: 5px; }
        
        .card { background: var(--card-bg); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.03); display: flex; flex-direction: column; }
        .card.full-height { height: 100%; }
        .card-header { font-size: 1.1rem; color: var(--primary-dark); font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--bg-main); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-body { flex-grow: 1; overflow-y: auto; } /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì˜ì—­ */
        
        /* í¼ ìš”ì†Œ */
        label { display: block; margin-bottom: 6px; color: var(--text-sub); font-size: 0.9rem; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; background: #fcfdfd; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: white; }
        
        /* ë²„íŠ¼ */
        .btn { display: inline-flex; justify-content: center; align-items: center; height: 42px; min-width: 80px; padding: 0 20px; border-radius: 6px; border: none; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; width: auto; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { height: 34px; min-width: 60px; padding: 0 12px; font-size: 0.9rem; border-radius: 6px; border: 1px solid; cursor: pointer; transition: 0.2s; }
        .btn-sm.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-sm.inactive { background: white; color: var(--text-sub); border-color: var(--border-color); }
        .btn-icon { font-size: 0.8rem; background: none; border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        .btn-edit { color: var(--primary); border-color: var(--primary-light); }
        .btn-del { color: var(--danger); }
        
        /* í™ˆ í™”ë©´ ì „ìš© */
        .home-img-area { 
            width: 100%; aspect-ratio: 4 / 3; background: #f0f0f0; border-radius: 8px; margin-bottom: 20px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; border: 2px dashed #ddd; cursor: pointer;
        }
        .home-img-area.has-image { border: none; }
        .home-img-area img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .home-img-placeholder { color: #aaa; font-size: 0.9rem; text-align: center; pointer-events: none; }
        .home-todo-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        .home-todo-check { margin-right: 10px; cursor: pointer; color: var(--border-color); }
        .home-todo-check.done { color: var(--success); }

        .quick-link-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .quick-link-item { 
            aspect-ratio: 1; background: white; border: 1px solid var(--border-color); border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
        }
        .quick-link-item:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .ql-emoji { font-size: 2rem; margin-bottom: 5px; }
        .ql-name { font-size: 0.8rem; color: var(--text-main); width: 90%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ql-add { font-size: 1.5rem; color: var(--primary); }
        .ql-remove { position: absolute; top: 2px; right: 2px; font-size: 0.7rem; color: #ccc; cursor: pointer; display: none; }
        .quick-link-item:hover .ql-remove { display: block; }

        /* ë¶ë§ˆí¬ ê·¸ë¦¬ë“œ ê°œí¸ */
        .bm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .bm-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; position: relative; transition: 0.2s; }
        .bm-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .bm-star { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #ddd; font-size: 1.2rem; }
        .bm-star.active { color: #f1c40f; }
        .bm-link { font-weight: bold; color: var(--primary-dark); text-decoration: none; font-size: 1.05rem; display: block; margin-bottom: 5px; margin-right: 20px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bm-tags { margin-bottom: 8px; height: 24px; overflow: hidden; }
        .bm-tag-disp { display: inline-block; background: #eaf6fc; color: var(--primary); font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }
        .bm-memo { font-size: 0.9rem; color: var(--text-sub); margin-top: auto; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* ë©”ëª¨ ë‹¬ë ¥ í”„ë¦¬ë·° */
        .memo-mini-item { 
            padding: 6px 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 0.85rem; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main);
        }
        .memo-mini-item:hover { background: #f9f9f9; color: var(--primary); }

        /* ìº˜ë¦°ë” */
        .cal-header { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; font-weight: bold; }
        .arrow-btn { background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-sub); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; margin-bottom: 15px; }
        .cal-day { padding: 8px 4px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; position: relative; height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .cal-day:hover { background: #eaf6fc; }
        .cal-day.today { background: #fffbe6; border: 1px solid #ffd591; }
        .cal-day.selected { border: 2px solid var(--primary-dark); }
        .cal-dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; margin-top: 4px; display: none; }
        .cal-day.has-memo .cal-dot { display: block; }

        /* í”Œë¡œíŒ… ë©”ë‰´ */
        .float-btn { position: fixed; top: 20px; right: 20px; width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 2100; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; transition: 0.3s; }
        .float-menu { position: fixed; top: 80px; right: 20px; display: none; flex-direction: column; gap: 10px; z-index: 2100; }
        .float-menu.show { display: flex; animation: fadeIn 0.2s; }
        .float-menu-item { background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; font-weight: bold; color: var(--text-main); text-align: right; border: 1px solid var(--border-color); transition: 0.2s; }

        @media (max-width: 1200px) { .bm-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 800px) { .bm-grid { grid-template-columns: 1fr; } }
        
        @media (max-width: 768px) {
            .container { padding: 10px; height: auto; display: block; }
            .section { height: auto; overflow: visible; }
            .pc-only { display: none !important; }
            .mobile-only { display: block !important; }
            .split-container { display: block; height: auto; }
            .split-left, .split-right { width: 100%; min-width: 0; overflow: visible; padding: 0; }
            .float-btn { top: auto; bottom: 80px; }
            .float-menu { top: auto; bottom: 140px; }
            .mobile-warning { text-align: center; padding: 50px 20px; color: var(--text-sub); }
            .mobile-warning .gear { font-size: 3rem; margin-bottom: 20px; display: block; }
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="lockScreen">
        <div id="lockCard">
            <h2 style="color:var(--primary-dark); margin-bottom:20px;">ì«‘ì•Œìˆ˜ì²© Pro</h2>
            <p style="margin-bottom:10px; color:var(--text-sub);">ê´€ë¦¬ì ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            <input type="password" id="lockInput" placeholder="Password" onkeyup="if(window.event.keyCode==13){unlockApp()}">
            <div class="lock-info" id="lockInfo"></div>
            <button class="btn btn-primary" onclick="unlockApp()" style="width:100%;">ì ‘ì†</button>
        </div>
    </div>

    <div class="float-btn" onclick="toggleFloatMenu()">+</div>
    <div class="float-menu" id="floatMenu">
        <div class="float-menu-item" onclick="changeSection('bookmarks')">ë¶ë§ˆí¬</div>
        <div class="float-menu-item" onclick="changeSection('calendar')">ë‹¬ë ¥/ì¼ì •</div>
        <div class="float-menu-item" onclick="changeSection('memo')">ë©”ëª¨/í• ì¼</div>
    </div>

    <div class="container">
        <header><h1>ì«‘ì•Œìˆ˜ì²© v13.0</h1></header>
        <nav class="nav-tabs">
            <div class="nav-item active" onclick="changeSection('home')">HOME</div>
            <div class="nav-item" onclick="changeSection('record')">ê¸°ë¡í•˜ê¸°</div>
            <div class="nav-item" onclick="changeSection('students')">í•™ìƒê´€ë¦¬</div>
            <div class="nav-item" onclick="changeSection('neis')">NEIS</div>
            <div class="nav-item" onclick="changeSection('data')">ì„¤ì •</div>
        </nav>

        <div id="home" class="section active">
            <div class="mobile-only mobile-warning">
                <span class="gear">âš™ï¸</span>
                í•´ë‹¹ ê¸°ëŠ¥ì€ PC/íƒœë¸”ë¦¿ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•´ìš”!
            </div>
            <div class="pc-only">
                <div class="split-container">
                    <div class="split-left">
                        <div class="card full-height">
                            <div class="card-header">My Desk</div>
                            <div class="card-body">
                                <div id="homeImageDropZone" class="home-img-area" onclick="triggerImgUpload()">
                                    <div class="home-img-placeholder">ì´ë¯¸ì§€ ë“œë˜ê·¸ & ë“œë¡­<br>(4:3 ë¹„ìœ¨ ê¶Œì¥)</div>
                                    <img id="homeImgDisplay" src="">
                                    <input type="file" id="homeImgInput" style="display:none;" accept="image/*" onchange="handleHomeImgUpload(this.files[0])">
                                </div>
                                <div style="font-weight:bold; margin-bottom:10px; color:var(--primary);">ì˜¤ëŠ˜ì˜ í•  ì¼</div>
                                <div id="homeTodoList">
                                    <div style="color:#aaa; font-size:0.9rem;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="split-right">
                        <div class="card full-height">
                            <div class="card-header">Quick Access</div>
                            <div class="card-body">
                                <div class="quick-link-grid" id="quickLinkGrid">
                                    </div>
                                <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
                                <label>ë¹ ë¥¸ ê¸°ë¡ (ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼)</label>
                                <textarea id="homeQuickInput" style="width:100%; height:100px; padding:15px; border:1px solid var(--border-color); border-radius:8px; resize:none;" placeholder="ë‚´ìš© ì…ë ¥... (ì˜ˆ: ê¹€ì² ìˆ˜/ìˆ˜í•™/ë°œí‘œ ì˜í•¨)"></textarea>
                                <button class="btn btn-primary" style="width:100%;" onclick="saveHomeQuickRecord()">âœ¨</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="record" class="section">
            <div class="mobile-only">
                <div class="mobile-record-card">
                    <label style="text-align:left;">ë‚ ì§œ ì„ íƒ</label><input type="date" id="mDate" style="margin-bottom:20px;">
                    <div style="display:flex; gap:10px; margin-bottom:15px; justify-content:center;">
                        <button class="btn active" id="mBtnSub" onclick="setMobileMode('subject')">ê³¼ëª©</button>
                        <button class="btn" id="mBtnBeh" onclick="setMobileMode('behavior')">í–‰ë™</button>
                    </div>
                    <textarea id="mInput" style="width:100%; height:150px; padding:15px; border:1px solid var(--border-color); border-radius:8px; font-size:1rem; margin-bottom:15px; resize:none;" placeholder="ì…ë ¥..."></textarea>
                    <button class="btn btn-primary" style="width:100%; height:50px;" onclick="saveMobileRecord()">âœ¨</button>
                </div>
            </div>
            <div class="pc-only">
                <div class="split-container">
                    <div class="split-left">
                        <div class="card full-height">
                            <div class="card-header">ê¸°ë³¸ ì •ë³´</div>
                            <div class="card-body">
                                <div style="display:flex; gap:5px; margin-bottom:15px;"><button class="btn-sm active" id="btnSubject" onclick="setMode('subject')">ê³¼ëª©</button><button class="btn-sm inactive" id="btnBehavior" onclick="setMode('behavior')">í–‰ë™</button></div>
                                <label>ë‚ ì§œ</label><input type="date" id="rDate">
                                <div id="periodArea"><label>êµì‹œ</label><select id="rPeriod"><option value="">(ì…ë ¥ì•ˆí•¨)</option><option>1êµì‹œ</option><option>2êµì‹œ</option><option>3êµì‹œ</option><option>4êµì‹œ</option><option>5êµì‹œ</option><option>6êµì‹œ</option></select></div>
                                <div id="subjectArea"><label>ê³¼ëª© ì„ íƒ</label><div class="tag-container" id="subjectTags"><div class="tag tag-add" onclick="openSubjectModal()">+</div></div><label>ì„±ì·¨ê¸°ì¤€/ì£¼ì œ</label><input type="text" id="rTopic" placeholder="ì˜ˆ: ì‹œ ë‚­ì†¡í•˜ê¸°"></div>
                            </div>
                        </div>
                    </div>
                    <div class="split-right">
                        <div class="card full-height">
                            <div class="card-header"><div style="display:flex; align-items:center; gap:15px;"><span>í•™ìƒë³„ ê¸°ë¡</span><div class="switch-container"><label class="switch"><input type="checkbox" id="aiToggle" checked><span class="slider"></span></label><span>AI</span></div></div><button class="btn btn-primary" id="btnSaveAll" onclick="saveData()">ì €ì¥í•˜ê¸°</button></div>
                            <div class="card-body">
                                <div style="display:flex; padding:0 10px 10px; border-bottom:2px solid var(--bg-main); font-weight:bold; color:var(--text-sub); font-size:0.9rem;"><div style="width:90px;">ì´ë¦„</div><div style="flex-grow:1; text-align:center;">ê´€ì°°/íŠ¹ê¸°ì‚¬í•­</div><div id="checkHeader" style="width:220px; display:flex; justify-content:space-between; font-size:0.8rem;"><span>ë§¤ìš°ì˜í•¨</span><span>ì˜í•¨</span><span>ë³´í†µ</span><span>ë…¸ë ¥ìš”í•¨</span></div></div>
                                <div id="recordList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="students" class="section">
            <div class="split-container">
                <div class="split-left">
                    <div class="card full-height">
                        <div class="card-header">í•™ìƒ ëª…ë‹¨</div>
                        <div class="card-body">
                             <div style="margin-bottom: 15px;"><button class="btn btn-outline" style="width:100%;" onclick="openStudentManageModal()">+ í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</button></div>
                             <div id="studentNavList"></div>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <div class="card full-height">
                        <div class="card-header"><span id="viewerTitle">ê¸°ë¡ ìƒì„¸ ë³´ê¸°</span><div style="display:flex; gap:5px; align-items:center;"><select id="viewSubjectFilter" style="margin-bottom:0; width:110px; padding:6px; font-size:0.9rem;" onchange="loadHistory()"></select><button class="btn-sm active" id="viewSubBtn" onclick="viewTab('subject')">ê³¼ëª©</button><button class="btn-sm inactive" id="viewBehBtn" onclick="viewTab('behavior')">í–‰ë™</button></div></div>
                        <div class="card-body">
                            <div style="margin-bottom:15px; display:flex; justify-content:space-between;"><button class="btn btn-sm btn-del" onclick="deleteSelectedHistory()">ì„ íƒ ì‚­ì œ</button></div>
                            <div id="historyViewer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="neis" class="section">
             <div class="mobile-only mobile-warning"><span class="gear">âš™ï¸</span>í•´ë‹¹ ê¸°ëŠ¥ì€ PC/íƒœë¸”ë¦¿ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•´ìš”!</div>
             <div class="pc-only">
                <div class="split-container">
                    <div class="split-left">
                        <div class="card full-height">
                            <div class="card-header">NEIS ì˜µì…˜</div>
                            <div class="card-body">
                                <label>ìœ í˜•</label><select id="neisType" onchange="toggleNeisType()"><option value="subject">ê³¼ëª©ë³„ ì„¸íŠ¹</option><option value="behavior">í–‰ë™íŠ¹ì„±</option></select>
                                <div id="neisSubOption"><label>ëŒ€ìƒ ê³¼ëª©</label><select id="neisSubjectSelect"></select></div>
                                <div id="neisBehOption" style="display:none;"><label>í‚¤ì›Œë“œ</label><input type="text" id="neisKeyword" placeholder="ì˜ˆ: ë°°ë ¤, í˜‘ë ¥"></div>
                                <label style="margin-top:15px;">ìƒì„± ë¶„ëŸ‰</label><div style="display:flex; align-items:center; gap:10px;"><input type="range" id="neisLen" min="100" max="1000" step="50" value="300" oninput="document.getElementById('lenVal').innerText=this.value"><span style="width:50px; text-align:right; font-weight:bold; color:var(--primary);"><span id="lenVal">300</span>ì</span></div>
                                <button class="btn btn-primary" id="btnGenNeis" style="margin-top:15px;" onclick="generateNeisCards()">ìë£Œ ìƒì„±í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                    <div class="split-right"><div class="card full-height"><div class="card-header">ìƒì„± ê²°ê³¼</div><div class="card-body" id="neisResultList"><div style="text-align:center;color:var(--text-sub);margin-top:20px;">ì˜µì…˜ ì„ íƒ í›„ ìƒì„±í•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div></div></div></div>
                </div>
            </div>
        </div>

        <div id="data" class="section">
             <div class="split-container">
                 <div class="split-left pc-only">
                    <div class="card full-height"><div class="card-header">ì°¸ê³  ìë£Œ (ë“œë¼ì´ë¸Œ)</div><div class="card-body"><input type="file" id="uploadInput" style="margin-bottom:10px;"><button class="btn btn-outline" id="btnUpload" style="width:100%; margin-bottom:15px;" onclick="uploadFile()">ì—…ë¡œë“œ</button><div id="fileList"></div></div></div>
                </div>
                <div class="split-right">
                    <div class="card full-height">
                        <div class="card-header">ì„¤ì •</div>
                        <div class="card-body">
                             <div id="publicModeSettings" style="display:none; margin-bottom:20px; background:#f9f9f9; padding:15px; border-radius:8px;"><label>Gemini API Key</label><input type="password" id="settingApiKey" placeholder="AIza..."><button class="btn btn-sm active" style="width:100%;" onclick="savePublicSettings()">ì €ì¥</button></div>
                             <label>AI í˜ë¥´ì†Œë‚˜</label><textarea id="personaText" style="height:150px;" placeholder="ì˜ˆ: ì´ˆë“±í•™êµ êµì‚¬ ë§íˆ¬..."></textarea><div style="text-align:right;"><button class="btn btn-primary" id="btnPersona" onclick="savePersona()">ì €ì¥</button></div>
                             <hr style="margin:20px 0;">
                             <p style="font-size:0.9rem; color:var(--text-sub); margin-bottom:10px;">ë°ì´í„° ë°±ì—… ë° ì´ˆê¸°í™”</p>
                             <button class="btn btn-danger" style="width:100%" onclick="archiveData()">[ìƒˆ í•™ë…„ ì¤€ë¹„] ë°ì´í„° ì´ê´€</button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <div id="bookmarks" class="section">
            <div class="split-container">
                <div class="split-left">
                    <div class="card full-height">
                        <div class="card-header">ë¶ë§ˆí¬ ì¶”ê°€</div>
                        <div class="card-body">
                            <input type="hidden" id="bmEditRow" value="">
                            <label>URL</label><input type="text" id="bmUrl" placeholder="https://..." style="margin-bottom:15px;">
                            <label>ì œëª© (ë¹„ì›Œë‘ë©´ AI)</label><input type="text" id="bmTitle" placeholder="ì„ íƒ ì…ë ¥">
                            <label>ê³¼ëª© íƒœê·¸</label><div id="bmTagArea" style="margin-bottom:15px;"></div>
                            <div style="margin-bottom:15px; display:flex; gap:5px;"><input type="text" id="newBmTagInput" placeholder="ìƒˆ íƒœê·¸" style="margin-bottom:0; flex:1;"><button class="btn-sm active" onclick="addNewBmTag()">+</button></div>
                            <label>ë©”ëª¨</label><textarea id="bmMemo" style="height:80px;" placeholder="í™œìš© íŒ..."></textarea>
                            <div style="display:flex; gap:10px;"><button class="btn btn-outline" style="flex:1" onclick="clearBmInput()">ì´ˆê¸°í™”</button><button class="btn btn-primary" style="flex:1" onclick="saveBookmark()" id="btnSaveBm">ì €ì¥</button></div>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <div class="card full-height">
                        <div class="card-header">
                            <span>ë¶ë§ˆí¬ ëª©ë¡</span>
                            <div id="bmFilterDisp" style="font-size:0.9rem; color:var(--primary); font-weight:normal; display:none;">í•„í„°: <span></span> <button class="btn-icon" onclick="filterBookmark(null)">x</button></div>
                        </div>
                        <div class="card-body">
                            <div id="bmList" class="bm-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="calendar" class="section">
            <div class="split-container">
                <div class="split-left">
                    <div class="card full-height">
                         <div class="cal-header">
                            <button class="arrow-btn" onclick="moveMonth(-1)">â—€</button>
                            <span id="calMonth"></span>
                            <button class="arrow-btn" onclick="moveMonth(1)">â–¶</button>
                            <button class="btn-sm" style="margin-left:10px;" onclick="goToToday()">[ì˜¤ëŠ˜]</button>
                        </div>
                        <div class="card-body">
                            <div class="cal-grid" id="calGrid"></div>
                            <hr style="margin:15px 0;">
                            <div style="font-weight:bold; margin-bottom:10px;">ì˜¤ëŠ˜ í•  ì¼</div>
                            <div id="todayTodoList" style="font-size:0.95rem; color:var(--text-sub);">ì¼ì • ì—†ìŒ</div>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <div class="card full-height">
                        <div class="card-header"><span id="calDetailTitle">ì„ íƒí•œ ë‚ ì§œ ì¼ì •</span></div>
                        <div class="card-body">
                            <label>ìƒˆ ì¼ì • ë“±ë¡ (êµ¬ê¸€ ìº˜ë¦°ë”)</label>
                            <div style="display:flex; gap:5px; margin-bottom:15px;">
                                <input type="text" id="newEvent" placeholder="ì¼ì • ë‚´ìš©" style="margin-bottom:0;">
                                <button class="btn-primary" onclick="addEvent()" style="width:80px; border-radius:6px;">ë“±ë¡</button>
                            </div>
                            <div id="dailyEvents" style="margin-bottom:20px;"></div>
                            
                            <div class="pc-only">
                                <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <div style="font-weight:bold; color:var(--primary-dark);">ì¶œì„ ì²´í¬</div>
                                    <div style="display:flex; gap:5px;"><button class="btn-sm" onclick="openMonthAttSummary()">ì›”ë³„ í˜„í™©</button><button class="btn-sm active" onclick="saveAttendance()">ì¶œì„ ì €ì¥</button></div>
                                </div>
                                <div id="attList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="memo" class="section">
             <div class="split-container">
                <div class="split-left">
                    <div class="card full-height">
                        <div class="card-header">
                            <span>ë©”ëª¨ ë³´ê¸°</span>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-sm active" id="btnMemoModeCal" onclick="setMemoMode('cal')">ë‹¬ë ¥</button>
                                <button class="btn-sm inactive" id="btnMemoModeList" onclick="setMemoMode('list')">ëª©ë¡</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="memoCalView">
                                <div class="cal-header"><button class="arrow-btn" onclick="moveMemoMonth(-1)">â—€</button><span id="memoMonthTitle"></span><button class="arrow-btn" onclick="moveMemoMonth(1)">â–¶</button></div>
                                <div class="cal-grid" id="memoCalGrid"></div>
                                <div id="memoDatePreview" style="display:none; border-top:1px solid #eee; margin-top:15px; padding-top:10px;">
                                    <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">ì„ íƒ ë‚ ì§œ ë©”ëª¨</div>
                                    <div id="memoDatePreviewList"></div>
                                </div>
                            </div>
                            <div id="memoListView" style="display:none;"></div>
                        </div>
                    </div>
                </div>
                <div class="split-right">
                    <div class="card full-height">
                        <div class="card-header">ë©”ëª¨ ì‘ì„±</div>
                        <div class="card-body">
                            <input type="hidden" id="memoEditRow" value="">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                 <span id="memoDateDisp" style="font-weight:bold; color:var(--primary);">ì˜¤ëŠ˜</span>
                                 <button class="btn-sm" onclick="clearMemoInput()">+ ìƒˆ ë©”ëª¨</button>
                            </div>
                            <textarea id="memoContent" style="height:300px;" placeholder="ë‚´ìš©..."></textarea>
                            <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                                <label style="margin:0;"><input type="checkbox" id="memoPinned"> ì¤‘ìš”</label>
                                <label style="margin:0;"><input type="checkbox" id="memoDone"> ì™„ë£Œë¨</label>
                            </div>
                            <div style="text-align:right;">
                                <button class="btn btn-danger" id="btnDelMemo" style="display:none; margin-right:10px;" onclick="deleteMemo()">ì‚­ì œ</button>
                                <button class="btn btn-primary" onclick="saveMemo()">ì €ì¥</button>
                            </div>
                        </div>
                    </div>
                </div>
             </div>
        </div>

    </div> <div id="status-bar"><span id="status-msg">ëŒ€ê¸°ì¤‘...</span><div class="loading-dots" style="color:white; font-weight:bold;"></div></div>
    <div id="toast"></div>
    <div id="subjectModal" class="modal-overlay"><div class="modal-card"><div class="modal-title">ìƒˆ ê³¼ëª© ì¶”ê°€</div><input type="text" id="newSubjectName" placeholder="ê³¼ëª©ëª…"><div style="text-align:right;"><button class="btn btn-outline" onclick="closeSubjectModal()">ì·¨ì†Œ</button> <button id="confirmSubjectBtn" class="btn btn-primary" onclick="confirmAddSubject()">ì¶”ê°€</button></div></div></div>
    <div id="deleteSubjectModal" class="modal-overlay"><div class="modal-card"><div class="modal-title" style="color:var(--danger)">ê³¼ëª© ì‚­ì œ</div><p>ê¸°ë¡ì´ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.</p><div style="text-align:right;"><button class="btn btn-outline" onclick="closeDeleteSubjectModal()">ì·¨ì†Œ</button> <button class="btn btn-danger" onclick="confirmDeleteSubject()">ì‚­ì œ</button></div></div></div>
    <div id="deleteStudentModal" class="modal-overlay"><div class="modal-card"><div class="modal-title" style="color:var(--danger)">í•™ìƒ ì‚­ì œ</div><p>ëª…ë‹¨ì—ì„œ ì‚­ì œë©ë‹ˆë‹¤.</p><div style="text-align:right;"><button class="btn btn-outline" onclick="closeDeleteStudentModal()">ì·¨ì†Œ</button> <button class="btn btn-danger" id="btnDelStudent" onclick="confirmDeleteStudent()">ì‚­ì œ</button></div></div></div>
    <div id="manageStudentModal" class="modal-overlay"><div class="modal-card" style="width:500px;"><div class="modal-title">í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</div><div class="modal-body" id="manageStudentRows"></div><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><button class="btn-sm active" onclick="addStudentRow()">+ í–‰ ì¶”ê°€</button></div><div style="text-align:right;"><button class="btn btn-outline" onclick="closeStudentManageModal()">ì·¨ì†Œ</button> <button class="btn btn-primary" id="btnManageStSave" onclick="saveStudentManagement()">ì „ì²´ ì €ì¥</button></div></div></div>
    <div id="monthAttModal" class="modal-overlay"><div class="modal-card" style="width:600px;"><div class="modal-title">ì›”ë³„ ì¶œì„ í˜„í™©</div><div class="modal-body" id="monthAttBody"></div><div style="text-align:right;"><button class="btn btn-outline" onclick="document.getElementById('monthAttModal').classList.remove('open')">ë‹«ê¸°</button></div></div></div>
    <div id="quickLinkModal" class="modal-overlay"><div class="modal-card"><div class="modal-title">í€µ ë§í¬ ì¶”ê°€</div><label>ì´ëª¨ì§€</label><input type="text" id="qlEmoji" placeholder="ğŸ”—"><label>ì‚¬ì´íŠ¸ ì´ë¦„</label><input type="text" id="qlName" placeholder="ë„¤ì´ë²„"><label>URL</label><input type="text" id="qlUrl" placeholder="https://..."><div style="text-align:right;"><button class="btn btn-outline" onclick="document.getElementById('quickLinkModal').classList.remove('open')">ì·¨ì†Œ</button> <button class="btn btn-primary" onclick="confirmAddQuickLink()">ì¶”ê°€</button></div></div></div>

    <script>
        const PRO_BACKEND_URL = "https://script.google.com/macros/s/AKfycbxn2nB0ZNXwXSdfx4-XVUWTD3Z_GCb_L2_SkhLyiKu5qrZrpwGTLM9Y4BhQRbveIk4o8Q/exec"; 
        const IS_GAS_ENV = window.location.hostname.includes('script.google.com');
        const IS_PRO_MODE = !IS_GAS_ENV && PRO_BACKEND_URL !== "";
        let currentMode = 'subject';
        let mobileMode = 'subject';
        let selectedStudentName = null;
        let viewTabMode = 'subject';
        let studentList = [];
        let subjectList = ["êµ­ì–´", "ìˆ˜í•™", "ì‚¬íšŒ", "ê³¼í•™", "ì˜ì–´", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ "];
        let targetSubjectToDelete = null;
        let aiPersona = "";
        let aiJobQueue = [];
        let isAiQueueRunning = false;
        let isGlobalProcessing = false;
        
        let curYear = new Date().getFullYear();
        let curMonth = new Date().getMonth();
        let selectedDate = formatDateYMD(new Date());
        let calendarEvents = [];
        
        let bmList = [];
        let bmFilter = null;
        let bmTags = ["êµ­ì–´", "ìˆ˜í•™", "ì‚¬íšŒ", "ê³¼í•™", "ì˜ì–´", "ì²´ìœ¡", "ìŒì•…", "ë¯¸ìˆ ", "ìë£Œ", "ì˜ìƒ"]; 
        let selectedBmTags = [];

        let memoList = [];
        let memoMode = 'cal';
        let curMemoMonth = new Date().getMonth();
        let curMemoYear = new Date().getFullYear();
        let selectedMemoDate = formatDateYMD(new Date());

        let quickLinks = []; // {emoji, name, url}

        // ë³´ì•ˆ: CapsLock & Language Check
        function checkLock() {
            if(sessionStorage.getItem('isUnlocked') === 'true') {
                document.getElementById('lockScreen').style.display = 'none';
            }
        }
        function unlockApp() {
            const val = document.getElementById('lockInput').value;
            if(val === 'ekdms320') {
                sessionStorage.setItem('isUnlocked', 'true');
                document.getElementById('lockScreen').style.display = 'none';
                loadFiles(); loadHomeData();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                document.getElementById('lockInput').value = '';
            }
        }
        document.getElementById('lockInput').addEventListener('keydown', (e) => {
             const info = document.getElementById('lockInfo');
             if(e.getModifierState("CapsLock")) info.innerText = "âš ï¸ Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤.";
             else info.innerText = "í•œ/ì˜ í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        });

        window.onload = () => {
            checkLock();
            document.getElementById('rDate').valueAsDate = new Date();
            document.getElementById('mDate').valueAsDate = new Date();
            initEnvironment();
            loadStudents();
            renderSubjectTags();
            updateNeisSubjectOptions();
            renderBmTags();
            
            if(sessionStorage.getItem('isUnlocked') === 'true') { loadFiles(); loadHomeData(); }

            window.onbeforeunload = function(e) {
                if(aiJobQueue.length > 0 || isAiQueueRunning) { e.preventDefault(); e.returnValue = ''; return "AI ë³€í™˜ ì‘ì—…ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤."; }
            };
        };

        // --- Helpers ---
        function setLoading(el, text) { if(!el) return; el.dataset.orgText = el.innerText; el.innerText = text; el.classList.add('loading-dots'); el.disabled = true; }
        function clearLoading(el) { if(!el) return; el.innerText = el.dataset.orgText || "ì™„ë£Œ"; el.classList.remove('loading-dots'); el.disabled = false; }
        function showToast(msg) { const t = document.getElementById("toast"); t.innerText = msg; t.className = "show"; setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000); }
        function formatDateYMD(dateObj) { 
            if (!dateObj) return ""; const d = new Date(dateObj); 
            const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); 
            return `${year}-${month}-${day}`; 
        }
        function sendRequest(action, payload = {}) {
            if (IS_PRO_MODE) {
                payload.action = action;
                return fetch(PRO_BACKEND_URL, { method: 'POST', mode: 'cors', body: JSON.stringify(payload) }).then(res => res.json()).then(json => { if (json.result === 'error') throw new Error(json.msg); return json.data; }).catch(err => { showToast("í†µì‹  ì˜¤ë¥˜: " + err.message); return null; });
            } else {
                return new Promise((resolve) => { google.script.run.withSuccessHandler(res => { if (res.result === 'error') { showToast("ì˜¤ë¥˜: " + res.msg); resolve(null); } else { resolve(res.data); } }).withFailureHandler(err => { showToast("ì„œë²„ ì˜¤ë¥˜: " + err); resolve(null); }).dispatch(action, payload); });
            }
        }
        function initEnvironment() {
            if (IS_PRO_MODE) { document.getElementById('publicModeSettings').style.display = 'none'; } 
            else { document.getElementById('publicModeSettings').style.display = 'block'; sendRequest('load_settings').then(res => { if(res) { document.getElementById('settingApiKey').value = res.apiKey || ""; document.getElementById('personaText').value = res.persona || ""; aiPersona = res.persona || ""; } }); }
        }

        // --- Navigation ---
        function changeSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-tabs .nav-item').forEach(e => e.classList.remove('active'));
            const navItem = document.querySelector(`.nav-tabs .nav-item[onclick="changeSection('${id}')"]`);
            if(navItem) navItem.classList.add('active');
            document.getElementById('floatMenu').classList.remove('show');

            if(id === 'home') loadHomeData();
            if(id === 'bookmarks') loadBookmarks();
            else if(id === 'calendar') { loadGoogleEvents().then(()=>{ renderCalendar(); showDailyView(new Date().getDate()); }); }
            else if(id === 'memo') { loadMemos(); }
        }
        function toggleFloatMenu() { document.getElementById('floatMenu').classList.toggle('show'); }

        // ================= HOME ê¸°ëŠ¥ =================
        async function loadHomeData() {
            // ì´ë¯¸ì§€ ë¡œë“œ
            sendRequest('get_home_image').then(res => {
                if(res && res.url) {
                    const img = document.getElementById('homeImgDisplay');
                    img.src = res.url;
                    img.style.display = 'block';
                    document.querySelector('.home-img-placeholder').style.display = 'none';
                    document.getElementById('homeImageDropZone').classList.add('has-image');
                }
            });
            // í€µ ë§í¬ ë¡œë“œ
            sendRequest('get_quick_links').then(res => {
                quickLinks = res || [];
                renderQuickLinks();
            });
            // ì˜¤ëŠ˜ì˜ í•  ì¼ ë¡œë“œ (ìº˜ë¦°ë” ì´ë²¤íŠ¸)
            loadGoogleEvents().then(() => {
                const todayStr = formatDateYMD(new Date());
                const todays = calendarEvents.filter(e => e.date === todayStr);
                const list = document.getElementById('homeTodoList');
                list.innerHTML = '';
                if(todays.length === 0) list.innerHTML = '<div style="color:#aaa; font-size:0.9rem;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                else {
                    todays.forEach(t => {
                        const d = document.createElement('div'); d.className = 'home-todo-item';
                        d.innerHTML = `<span class="home-todo-check" onclick="this.classList.toggle('done')">âœ”</span><span>${t.title}</span>`;
                        list.appendChild(d);
                    });
                }
            });
        }

        // ì´ë¯¸ì§€ ë“œë˜ê·¸ì•¤ë“œë¡­
        const dropZone = document.getElementById('homeImageDropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#eaf6fc'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.background = '#f0f0f0'; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); dropZone.style.background = '#f0f0f0';
            if(e.dataTransfer.files.length) handleHomeImgUpload(e.dataTransfer.files[0]);
        });
        function triggerImgUpload() { document.getElementById('homeImgInput').click(); }
        function handleHomeImgUpload(file) {
            if(!file.type.startsWith('image/')) { showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                showToast("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...");
                const res = await sendRequest('save_home_image', { name: file.name, mimeType: file.type, data: base64 });
                if(res.url) {
                    const img = document.getElementById('homeImgDisplay');
                    img.src = res.url; img.style.display='block';
                    document.querySelector('.home-img-placeholder').style.display='none';
                    dropZone.classList.add('has-image');
                }
            };
            reader.readAsDataURL(file);
        }

        // í€µ ë§í¬
        function renderQuickLinks() {
            const grid = document.getElementById('quickLinkGrid'); grid.innerHTML = '';
            quickLinks.forEach((q, idx) => {
                const div = document.createElement('div'); div.className = 'quick-link-item';
                div.innerHTML = `<div class="ql-emoji">${q.emoji}</div><div class="ql-name">${q.name}</div><div class="ql-remove" onclick="removeQuickLink(${idx}, event)">x</div>`;
                div.onclick = (e) => { if(!e.target.classList.contains('ql-remove')) window.open(q.url, '_blank'); };
                grid.appendChild(div);
            });
            if(quickLinks.length < 5) {
                const addDiv = document.createElement('div'); addDiv.className = 'quick-link-item';
                addDiv.innerHTML = `<div class="ql-add">+</div>`;
                addDiv.onclick = () => document.getElementById('quickLinkModal').classList.add('open');
                grid.appendChild(addDiv);
            }
        }
        async function confirmAddQuickLink() {
            const emoji = document.getElementById('qlEmoji').value || 'ğŸ”—';
            const name = document.getElementById('qlName').value;
            const url = document.getElementById('qlUrl').value;
            if(!name || !url) return;
            quickLinks.push({emoji, name, url});
            await sendRequest('save_quick_links', {links: quickLinks});
            renderQuickLinks();
            document.getElementById('quickLinkModal').classList.remove('open');
            document.getElementById('qlName').value=''; document.getElementById('qlUrl').value='';
        }
        async function removeQuickLink(idx, e) {
            e.stopPropagation();
            if(confirm('ì‚­ì œ?')) {
                quickLinks.splice(idx, 1);
                await sendRequest('save_quick_links', {links: quickLinks});
                renderQuickLinks();
            }
        }
        async function saveHomeQuickRecord() {
            const text = document.getElementById('homeQuickInput').value.trim();
            if(!text) return;
            showToast("AI ë¶„ì„ ì¤‘...");
            const prompt = `ì‚¬ìš©ì ì…ë ¥ JSON ì¶”ì¶œ. ëª¨ë“œ:subject. ì…ë ¥:"${text}". ê·œì¹™: ì´ë¦„/ê³¼ëª©/ë‚´ìš© ë¶„ë¦¬. í‰ì–´ì²´. ì¶œë ¥JSON:{"name":"ì´ë¦„","type":"ê³¼ëª©","text":"ë‚´ìš©"}`;
            try {
                const aiRes = await sendRequest('call_ai', { prompt });
                const jsonStr = aiRes.text.replace(/```json/g, "").replace(/```/g, "").trim();
                const parsed = JSON.parse(jsonStr);
                await sendRequest('save_record', { date: formatDateYMD(new Date()), name: parsed.name, type: parsed.type, text: parsed.text.replace(/['"]/g, "").replace(/\*\*/g, ""), check: "ì—†ìŒ" });
                showToast(`[${parsed.name}] ì €ì¥ ì™„ë£Œ`); document.getElementById('homeQuickInput').value = "";
            } catch (e) { showToast("ì‹¤íŒ¨"); }
        }

        // ================= ë¶ë§ˆí¬ (ê°œí¸) =================
        function renderBmTags() {
            const area = document.getElementById('bmTagArea'); area.innerHTML = '';
            bmTags.forEach(t => {
                const btn = document.createElement('div'); btn.className = 'bm-tag-btn';
                btn.innerHTML = `${t} <span onclick="removeBmTag('${t}', event)" style="margin-left:5px; font-size:0.7rem; color:#999;">x</span>`;
                if(selectedBmTags.includes(t)) btn.classList.add('selected');
                btn.onclick = (e) => { if(e.target.tagName === 'SPAN') return; toggleBmTag(t); };
                area.appendChild(btn);
            });
        }
        function toggleBmTag(t) { if(selectedBmTags.includes(t)) selectedBmTags = selectedBmTags.filter(item => item !== t); else selectedBmTags.push(t); renderBmTags(); }
        function addNewBmTag() { const val = document.getElementById('newBmTagInput').value.trim(); if(val && !bmTags.includes(val)) { bmTags.push(val); document.getElementById('newBmTagInput').value=''; renderBmTags(); } }
        function removeBmTag(t, e) { e.stopPropagation(); if(confirm('íƒœê·¸ ëª©ë¡ì—ì„œ ì‚­ì œ?')) { bmTags = bmTags.filter(item => item !== t); renderBmTags(); } }

        async function loadBookmarks() {
            const list = document.getElementById('bmList'); list.innerHTML = '<div class="loading-dots"></div>';
            bmList = await sendRequest('get_bookmarks') || [];
            renderBmList();
        }
        function renderBmList() {
            const list = document.getElementById('bmList'); list.innerHTML = '';
            let filtered = bmFilter ? bmList.filter(b => b.tags && b.tags.includes(bmFilter)) : bmList;
            
            // ì¤‘ìš”ë„ ìˆœ ì •ë ¬ (trueê°€ ìœ„ë¡œ)
            filtered.sort((a, b) => (b.starred === true) - (a.starred === true));

            if(filtered.length === 0) list.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px; color:#999;">ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            
            filtered.forEach(b => {
                const card = document.createElement('div'); card.className = 'bm-card';
                const tagArr = b.tags ? b.tags.split(',') : [];
                let tagHtml = tagArr.map(t => `<span class="bm-tag-disp" onclick="filterBookmark('${t.trim()}')">${t.trim()}</span>`).join('');
                
                card.innerHTML = `
                    <div class="bm-star ${b.starred?'active':''}" onclick="toggleBmStar(${b.row}, ${!b.starred})">â˜…</div>
                    <a href="${b.url}" target="_blank" class="bm-link">${b.title}</a>
                    <div class="bm-tags">${tagHtml}</div>
                    <div class="bm-memo">${b.memo}</div>
                    <div style="margin-top:10px; text-align:right;">
                        <button class="btn-icon btn-edit" onclick="editBookmark(${b.row})">âœï¸</button>
                        <button class="btn-icon btn-del" onclick="deleteBookmark(${b.row})">ğŸ—‘ï¸</button>
                    </div>
                `;
                list.appendChild(card);
            });
            const disp = document.getElementById('bmFilterDisp');
            if(bmFilter) { disp.style.display = 'inline-block'; disp.querySelector('span').innerText = bmFilter; }
            else { disp.style.display = 'none'; }
        }
        function filterBookmark(subj) { bmFilter = subj; renderBmList(); }
        async function toggleBmStar(row, starred) {
            // UI ì¦‰ì‹œ ë°˜ì˜ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
            const item = bmList.find(b => b.row === row);
            if(item) item.starred = starred;
            renderBmList();
            await sendRequest('toggle_bookmark_star', {row, starred});
        }
        async function saveBookmark() {
            const url = document.getElementById('bmUrl').value;
            const title = document.getElementById('bmTitle').value;
            const memo = document.getElementById('bmMemo').value;
            const row = document.getElementById('bmEditRow').value;
            const tagsStr = selectedBmTags.join(', ');
            
            if(!url) { showToast("URLì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
            const btn = document.getElementById('btnSaveBm'); setLoading(btn, "ì €ì¥ ì¤‘");
            
            const res = await sendRequest('save_bookmark', { row: row ? parseInt(row) : null, tags: tagsStr, title: title||"", url, memo });
            
            if (!title || selectedBmTags.length === 0) {
                showToast("ì €ì¥ë¨. AI ë¶„ë¥˜ ì¤‘...");
                clearBmInput(); loadBookmarks(); 
                sendRequest('process_bookmark_ai', { row: res.rowNum, url: url, availableTags: bmTags }).then(aiRes => {
                    loadBookmarks(); clearLoading(btn);
                });
            } else {
                clearBmInput(); loadBookmarks(); clearLoading(btn); showToast("ì €ì¥ ì™„ë£Œ");
            }
        }
        function editBookmark(row) {
            const item = bmList.find(b => b.row === row);
            if(!item) return;
            document.getElementById('bmUrl').value = item.url;
            document.getElementById('bmTitle').value = item.title;
            document.getElementById('bmMemo').value = item.memo;
            document.getElementById('bmEditRow').value = item.row;
            selectedBmTags = item.tags ? item.tags.split(',').map(s=>s.trim()) : [];
            renderBmTags();
            document.getElementById('bmUrl').focus();
        }
        function clearBmInput() {
            document.getElementById('bmUrl').value = ''; document.getElementById('bmTitle').value = '';
            document.getElementById('bmMemo').value = ''; document.getElementById('bmEditRow').value = '';
            selectedBmTags = []; renderBmTags();
        }
        async function deleteBookmark(row) { if(confirm('ì‚­ì œ?')) { await sendRequest('delete_bookmark', {row}); loadBookmarks(); } }

        // ================= ìº˜ë¦°ë”/ì¼ì • =================
        async function loadGoogleEvents() { calendarEvents = await sendRequest('get_events') || []; }
        function moveMonth(dir) { curMonth += dir; if(curMonth>11) { curMonth=0; curYear++; } else if(curMonth<0) { curMonth=11; curYear--; } renderCalendar(); }
        function goToToday() {
            const today = new Date(); curYear = today.getFullYear(); curMonth = today.getMonth(); selectedDate = formatDateYMD(today);
            renderCalendar(); showDailyView(today.getDate());
        }
        async function renderCalendar() {
            const grid = document.getElementById('calGrid'); grid.innerHTML='';
            document.getElementById('calMonth').innerText = `${curYear}ë…„ ${curMonth+1}ì›”`;
            const firstDay = new Date(curYear, curMonth, 1);
            const lastDay = new Date(curYear, curMonth+1, 0);
            const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            days.forEach(d => { const div=document.createElement('div'); div.innerText=d; div.style.fontWeight='bold'; grid.appendChild(div); });
            for(let i=0; i<firstDay.getDay(); i++) grid.appendChild(document.createElement('div'));
            
            for(let i=1; i<=lastDay.getDate(); i++) {
                const d = document.createElement('div'); d.className='cal-day'; d.innerHTML=`<span>${i}</span><div class="cal-dot"></div>`;
                const dateStr = `${curYear}-${String(curMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                if(dateStr === selectedDate) d.classList.add('selected');
                const today = new Date();
                if(today.getFullYear()===curYear && today.getMonth()===curMonth && today.getDate()===i) d.classList.add('today');
                const hasEvent = calendarEvents.some(e => e.date === dateStr);
                if(hasEvent) d.classList.add('has-memo');
                d.onclick = () => { selectedDate = dateStr; renderCalendar(); showDailyView(i); };
                grid.appendChild(d);
            }
        }
        async function showDailyView(day) {
            document.getElementById('calDetailTitle').innerText = `${selectedDate} ì¼ì • (Google)`;
            const evDiv = document.getElementById('dailyEvents');
            const todays = calendarEvents.filter(e => e.date === selectedDate);
            evDiv.innerHTML='';
            todays.forEach(e => {
                const d = document.createElement('div'); d.style.padding="8px"; d.style.borderBottom="1px solid #eee";
                d.innerHTML = `<span>${e.title}</span>`;
                evDiv.appendChild(d);
            });
            if(todays.length === 0) evDiv.innerHTML = '<div style="color:#999; padding:10px;">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            
            const attDiv = document.getElementById('attList'); attDiv.innerHTML='ë¡œë”©...';
            const attData = await sendRequest('get_attendance');
            const existAtt = attData ? attData.filter(a => a.date === selectedDate) : [];
            attDiv.innerHTML='';
            studentList.forEach(st => {
                const exist = existAtt.find(a => a.name === st.name);
                const status = exist ? exist.status : 'ì¶œì„';
                const memo = exist ? exist.memo : '';
                const row = document.createElement('div'); row.className='att-row';
                row.innerHTML = `<span style="width:60px; font-weight:bold;">${st.name}</span><select class="att-status att-sel" data-name="${st.name}"><option ${status==='ì¶œì„'?'selected':''}>ì¶œì„</option><option ${status==='ê²°ì„'?'selected':''}>ê²°ì„</option><option ${status==='ì§€ê°'?'selected':''}>ì§€ê°</option><option ${status==='ì¡°í‡´'?'selected':''}>ì¡°í‡´</option><option ${status==='ê²°ê³¼'?'selected':''}>ê²°ê³¼</option><option ${status==='ì²´í—˜'?'selected':''}>ì²´í—˜</option></select><input type="text" class="att-memo" placeholder="ì‚¬ìœ " value="${memo}" style="width:100px; margin-bottom:0; font-size:0.8rem; padding:4px;">`;
                attDiv.appendChild(row);
            });
        }
        async function addEvent() {
            const title = document.getElementById('newEvent').value; if(!title) return;
            await sendRequest('save_event', {date:selectedDate, title, type:'ì¼ë°˜'});
            document.getElementById('newEvent').value=''; 
            loadGoogleEvents().then(() => showDailyView(new Date(selectedDate).getDate()));
        }
        async function saveAttendance() {
            const list = [];
            document.querySelectorAll('.att-row').forEach(row => { list.push({ name: row.querySelector('.att-status').dataset.name, status: row.querySelector('.att-status').value, memo: row.querySelector('.att-memo').value }); });
            await sendRequest('save_attendance', {date:selectedDate, data:list}); showToast('ì¶œì„ ì €ì¥ ì™„ë£Œ');
        }

        // ================= ë©”ëª¨ (ê°œì„ ) =================
        async function loadMemos() { memoList = await sendRequest('get_memos') || []; selectedMemoDate = formatDateYMD(new Date()); setMemoMode(memoMode); }
        function moveMemoMonth(dir) { curMemoMonth += dir; if(curMemoMonth>11) { curMemoMonth=0; curMemoYear++; } else if(curMemoMonth<0) { curMemoMonth=11; curMemoYear--; } renderMemoCalendar(); }
        function renderMemoCalendar() {
            const grid = document.getElementById('memoCalGrid'); grid.innerHTML='';
            document.getElementById('memoMonthTitle').innerText = `${curMemoYear}ë…„ ${curMemoMonth+1}ì›”`;
            const first = new Date(curMemoYear, curMemoMonth, 1);
            const last = new Date(curMemoYear, curMemoMonth+1, 0);
            const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            days.forEach(d => { const div=document.createElement('div'); div.innerText=d; div.style.fontWeight='bold'; grid.appendChild(div); });
            for(let i=0; i<first.getDay(); i++) grid.appendChild(document.createElement('div'));
            
            for(let i=1; i<=last.getDate(); i++) {
                const dateStr = `${curMemoYear}-${String(curMemoMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const hasMemo = memoList.some(m => m.date === dateStr);
                const d = document.createElement('div'); d.className='cal-day'; 
                if(hasMemo) d.classList.add('has-memo');
                if(dateStr === selectedMemoDate) d.classList.add('selected');
                d.innerHTML = `<span>${i}</span><div class="cal-dot"></div>`;
                d.onclick = () => { selectedMemoDate = dateStr; renderMemoCalendar(); renderMemoDatePreview(); clearMemoInput(); document.getElementById('memoDateDisp').innerText = selectedMemoDate; };
                grid.appendChild(d);
            }
            renderMemoDatePreview();
        }
        function renderMemoDatePreview() {
            const previewArea = document.getElementById('memoDatePreview');
            const previewList = document.getElementById('memoDatePreviewList');
            const targetMemos = memoList.filter(m => m.date === selectedMemoDate);
            if(targetMemos.length === 0) { previewArea.style.display = 'none'; } 
            else {
                previewArea.style.display = 'block'; previewList.innerHTML = '';
                targetMemos.forEach(m => {
                   const div = document.createElement('div'); div.className = 'memo-mini-item';
                   div.innerHTML = `${m.pinned ? 'â˜… ' : ''}${m.content}`;
                   div.onclick = () => openMemoForm(m);
                   previewList.appendChild(div);
                });
            }
        }
        function openMemoForm(memoItem = null) {
            document.getElementById('memoDateDisp').innerText = selectedMemoDate;
            document.getElementById('btnDelMemo').style.display = 'none';
            if(memoItem) {
                document.getElementById('memoContent').value = memoItem.content;
                document.getElementById('memoPinned').checked = memoItem.pinned;
                document.getElementById('memoDone').checked = memoItem.done;
                document.getElementById('memoEditRow').value = memoItem.row;
                document.getElementById('btnDelMemo').style.display = 'inline-block';
            } else { clearMemoInput(); }
        }
        function clearMemoInput() {
            document.getElementById('memoContent').value = ''; document.getElementById('memoPinned').checked = false;
            document.getElementById('memoDone').checked = false; document.getElementById('memoEditRow').value = ''; document.getElementById('btnDelMemo').style.display = 'none';
        }
        async function saveMemo() {
            const content = document.getElementById('memoContent').value; const pinned = document.getElementById('memoPinned').checked; const done = document.getElementById('memoDone').checked; const row = document.getElementById('memoEditRow').value;
            if(!content) { showToast("ë‚´ìš© ì…ë ¥ í•„ìš”"); return; }
            await sendRequest('save_memo', { row: row?parseInt(row):null, content, pinned, done }); showToast("ë©”ëª¨ ì €ì¥ë¨"); loadMemos();
        }
        async function deleteMemo() { const row = document.getElementById('memoEditRow').value; if(row && confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await sendRequest('delete_memo', {row: parseInt(row)}); showToast("ì‚­ì œë¨"); loadMemos(); } }

        // --- ê¸°íƒ€ ê¸°ëŠ¥ (íŒŒì¼, ì„¤ì •, í•™ìƒ ë“± ê¸°ì¡´ ë™ì¼) ---
        async function savePublicSettings() { const key = document.getElementById('settingApiKey').value.trim(); if(!key) return; await sendRequest('save_settings', { apiKey: key }); showToast("ì €ì¥ ì™„ë£Œ"); }
        async function savePersona() { const p = document.getElementById('personaText').value; aiPersona = p; const btn = document.getElementById('btnPersona'); setLoading(btn, "ì €ì¥ ì¤‘"); if(!IS_PRO_MODE) await sendRequest('save_persona', { persona: p }); showToast("ì €ì¥ ì™„ë£Œ"); clearLoading(btn); }
        async function archiveData() { if(!confirm("âš ï¸ ê²½ê³  âš ï¸\në°ì´í„°ê°€ ë°±ì—…ë˜ê³  ì‹œíŠ¸ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\nìƒˆ í•™ë…„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const btn = document.querySelector('.btn-danger'); setLoading(btn, "ì´ê´€ ì¤‘"); const res = await sendRequest('archive_data'); alert(res.msg); clearLoading(btn); location.reload(); }
        function uploadFile() { const input = document.getElementById('uploadInput'); if(input.files.length === 0) return; const file = input.files[0]; const reader = new FileReader(); const btn = document.getElementById('btnUpload'); reader.onload = async function(e) { const base64 = e.target.result.split(',')[1]; setLoading(btn, "ì—…ë¡œë“œ ì¤‘"); const res = await sendRequest('upload_file', { name: file.name, mimeType: file.type, data: base64 }); if(res) { showToast("ì™„ë£Œ"); loadFiles(); input.value = ''; } clearLoading(btn); }; reader.readAsDataURL(file); }
        async function loadFiles() { const list = document.getElementById('fileList'); list.innerHTML = 'ë¡œë”©...'; const files = await sendRequest('get_files'); list.innerHTML = ''; if(files) files.forEach(f => { const div = document.createElement('div'); div.style.padding = "10px"; div.style.borderBottom = "1px solid #eee"; div.innerHTML = `<a href="${f.url}" target="_blank" style="text-decoration:none; color:var(--primary); font-weight:bold;">ğŸ“„ ${f.name}</a>`; list.appendChild(div); }); }

        function setMode(mode) { currentMode = mode; document.getElementById('btnSubject').className = mode === 'subject' ? 'btn-sm active' : 'btn-sm inactive'; document.getElementById('btnBehavior').className = mode === 'behavior' ? 'btn-sm active' : 'btn-sm inactive'; document.getElementById('subjectArea').style.display = mode === 'subject' ? 'block' : 'none'; document.getElementById('checkHeader').style.visibility = mode === 'subject' ? 'visible' : 'hidden'; renderRecordList(); }
        function renderRecordList() { const list = document.getElementById('recordList'); list.innerHTML = ''; studentList.forEach(st => { const row = document.createElement('div'); row.className = 'student-row'; let checkHtml = currentMode === 'subject' ? `<div class="st-check-group"><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div><div class="check-circle" onclick="toggleCheck(this)"></div></div>` : ''; row.innerHTML = `<div class="st-name">${st.id}. ${st.name}</div><div style="flex-grow:1; position:relative;"><input type="text" class="st-input" id="input_${st.id}" placeholder="${currentMode==='subject'?'ê´€ì°°/íŠ¹ê¸°ì‚¬í•­':'í–‰ë™íŠ¹ì„±'}"><span class="ai-magic" onclick="runAI('${st.id}', this)">âœ¨</span></div>${checkHtml}`; list.appendChild(row); }); toggleAIMode(); }
        function toggleCheck(el) { const p = el.parentElement; const was = el.classList.contains('checked'); p.querySelectorAll('.check-circle').forEach(c => c.classList.remove('checked')); if(!was) el.classList.add('checked'); }
        async function saveData() { const inputs = document.querySelectorAll('.st-input'); const btn = document.getElementById('btnSaveAll'); const isAI = document.getElementById('aiToggle').checked; let targetType = "í–‰ë™"; if(currentMode === 'subject') { const selTag = document.querySelector('#subjectTags .tag.selected'); if(!selTag) { showToast("ê³¼ëª© ì„ íƒ í•„ìš”"); return; } targetType = selTag.innerText.split(' ')[0].trim(); } setLoading(btn, "ì €ì¥ ì¤‘"); let itemsToSave = []; inputs.forEach(input => { const text = input.value.trim(); const row = input.closest('.student-row'); const name = row.querySelector('.st-name').innerText.split('.')[1].trim(); let checkVal = "ì—†ìŒ"; if(currentMode === 'subject') { const checks = row.querySelectorAll('.check-circle'); if(checks[0].classList.contains('checked')) checkVal = "ë§¤ìš°ì˜í•¨"; else if(checks[1].classList.contains('checked')) checkVal = "ì˜í•¨"; else if(checks[2].classList.contains('checked')) checkVal = "ë³´í†µ"; else if(checks[3].classList.contains('checked')) checkVal = "ë…¸ë ¥ìš”í•¨"; } if (text.length > 0 || checkVal !== "ì—†ìŒ") itemsToSave.push({ input, name, text, checkVal }); }); if (itemsToSave.length === 0) { showToast("ì €ì¥í•  ë‚´ìš© ì—†ìŒ"); clearLoading(btn); return; } for (const item of itemsToSave) { let period = document.getElementById('rPeriod').value; const topic = document.getElementById('rTopic').value.trim(); let periodPrefix = period ? `[${period}]` : ""; let rawBody = topic ? `[${topic}] ${item.text}` : item.text; if(item.text.length === 0) rawBody = topic ? `[${topic}] í™œë™ì— ì°¸ì—¬í•¨` : `ìˆ˜ì—… í™œë™ì— ì°¸ì—¬í•¨`; rawBody = `${periodPrefix} ${rawBody}`.trim(); const res = await sendRequest('save_record', { date: document.getElementById('rDate').value, name: item.name, type: targetType, text: rawBody, check: item.checkVal }); if (isAI && res && res.rowNum) aiJobQueue.push({ rowNum: res.rowNum, type: targetType, topic: topic, text: item.text, check: item.checkVal, name: item.name, periodPrefix: periodPrefix }); } clearLoading(btn); inputs.forEach(el => el.value = ''); document.querySelectorAll('.check-circle').forEach(el => el.classList.remove('checked')); showToast("ì €ì¥ ì™„ë£Œ (AI ë³€í™˜ ëŒ€ê¸°)"); processNextAiJob(); }
        async function processNextAiJob() { if (aiJobQueue.length === 0) { isAiQueueRunning = false; document.getElementById('status-bar').className = ''; return; } isAiQueueRunning = true; document.getElementById('status-bar').className = 'show'; const job = aiJobQueue[0]; document.getElementById('status-msg').innerText = `AI ë³€í™˜ ì¤‘... (${job.name}) - ëŒ€ê¸° ${aiJobQueue.length}ê±´`; const prompt = `ì—­í• :ì´ˆë“±êµì‚¬. ê³¼ì œ:ìƒê¸°ë¶€ ë¬¸ì¥ 1ê°œ. ì…ë ¥ì •ë³´: ì£¼ì œ:${job.topic||'ì—†ìŒ'}, ë©”ëª¨:${job.text||'ì—†ìŒ'}, í‰ê°€:${job.check}. ì›ì¹™: ë©”ëª¨ ì—†ìœ¼ë©´ ì£¼ì œ+í‰ê°€ë¡œ êµ¬ì²´ì  ì„œìˆ . ë©”ëª¨ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ê²°í•©. ì°¬ì–‘ì¡° ì§€ì–‘. **êµµê²Œ** ê¸ˆì§€. ~í•¨/ìŒ ì¢…ê²°(í•©ì‡¼ì²´ ê¸ˆì§€). ${aiPersona}`; try { const aiData = await sendRequest('call_ai', { prompt }); if (aiData && aiData.text) { let finalBody = aiData.text.replace(/['"]/g, "").replace(/\*\*/g, "").replace(/##/g, "").trim(); finalBody = `${job.periodPrefix} ${finalBody}`.trim(); await sendRequest('update_record_row', { type: job.type, rowNum: job.rowNum, text: finalBody }); } } catch (e) { console.error("BG AI Error:", e); } aiJobQueue.shift(); processNextAiJob(); }
        document.getElementById('aiToggle').addEventListener('change', toggleAIMode); function toggleAIMode() { const on = document.getElementById('aiToggle').checked; document.querySelectorAll('.ai-magic').forEach(e => e.style.display = on ? 'block' : 'none'); }
        async function runAI(studentId, btnEl) { const input = document.getElementById(`input_${studentId}`); if(!input) return; const row = input.closest('.student-row'); let checkVal = "í‰ê°€ì—†ìŒ"; if(currentMode === 'subject') { const checks = row.querySelectorAll('.check-circle'); if(checks[0].classList.contains('checked')) checkVal = "ë§¤ìš° ì˜í•¨"; else if(checks[1].classList.contains('checked')) checkVal = "ì˜í•¨"; else if(checks[2].classList.contains('checked')) checkVal = "ë³´í†µ"; else if(checks[3].classList.contains('checked')) checkVal = "ë…¸ë ¥ ìš”í•¨"; } const topic = document.getElementById('rTopic').value; const text = input.value; btnEl.classList.add('loading-dots'); input.disabled = true; const prompt = `ì—­í• :ì´ˆë“±êµì‚¬. ê³¼ì œ:ìƒê¸°ë¶€ ë¬¸ì¥. ì…ë ¥: ì£¼ì œ:${topic||'ì—†ìŒ'}, ë©”ëª¨:${text||'ì—†ìŒ'}, í‰ê°€:${checkVal}. ì›ì¹™: êµ¬ì²´ì  ì„œìˆ , ìì—°ìŠ¤ëŸ½ê²Œ, ì°¬ì–‘ì¡° ì§€ì–‘, **êµµê²Œ** ê¸ˆì§€, ~í•¨/ìŒ ì¢…ê²°. ${aiPersona}`; const data = await sendRequest('call_ai', { prompt }); input.disabled = false; btnEl.classList.remove('loading-dots'); if(data && data.text) input.value = data.text.replace(/['"]/g, "").replace(/\*\*/g, "").replace(/##/g, ""); else showToast("AI ì‹¤íŒ¨"); }
        function openMonthAttSummary() { const modal = document.getElementById('monthAttModal'); modal.classList.add('open'); const body = document.getElementById('monthAttBody'); body.innerHTML = 'ë¡œë”©ì¤‘...'; sendRequest('get_attendance').then(attData => { if(!attData) { body.innerHTML='ë°ì´í„° ì—†ìŒ'; return; } const thisMonthPrefix = `${curYear}-${String(curMonth+1).padStart(2,'0')}`; const monthData = attData.filter(a => a.date.startsWith(thisMonthPrefix) && a.status !== 'ì¶œì„'); let html = '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;"><thead><tr style="background:#eee;"><th style="border:1px solid #ddd; padding:5px;">ë‚ ì§œ</th><th style="border:1px solid #ddd;">ì´ë¦„</th><th style="border:1px solid #ddd;">ìƒíƒœ</th><th style="border:1px solid #ddd;">ë¹„ê³ </th></tr></thead><tbody>'; monthData.forEach(d => { html += `<tr><td style="border:1px solid #ddd; padding:5px;">${d.date.substring(5)}</td><td style="border:1px solid #ddd;">${d.name}</td><td style="border:1px solid #ddd; color:red; font-weight:bold;">${d.status}</td><td style="border:1px solid #ddd;">${d.memo}</td></tr>`; }); html += '</tbody></table>'; if(monthData.length === 0) html = '<div style="text-align:center; padding:20px;">íŠ¹ì´ì‚¬í•­(ê²°ì„ ë“±) ì—†ìŒ</div>'; body.innerHTML = html; }); }
        // Mobile Only Logic
        function setMobileMode(mode) { mobileMode = mode; document.getElementById('mBtnSub').className = mode === 'subject' ? 'btn active' : 'btn'; document.getElementById('mBtnBeh').className = mode === 'behavior' ? 'btn active' : 'btn'; }
        async function saveMobileRecord() { const text = document.getElementById('mInput').value.trim(); if(!text) { showToast("ë‚´ìš© ì…ë ¥ í•„ìš”"); return; } const btn = document.querySelector('.mobile-record-card .btn-primary'); setLoading(btn, "AI ë¶„ì„ ì¤‘"); const prompt = `ì‚¬ìš©ì ì…ë ¥ JSON ì¶”ì¶œ. ëª¨ë“œ:${mobileMode}. ì…ë ¥:"${text}". ê·œì¹™: ì´ë¦„/ê³¼ëª©/ë‚´ìš© ë¶„ë¦¬. í‰ì–´ì²´(~í•¨/ìŒ). ë”°ì˜´í‘œ ê¸ˆì§€. ì¶œë ¥JSON:{"name":"ì´ë¦„","type":"ê³¼ëª©","text":"ë‚´ìš©"}`; try { const aiRes = await sendRequest('call_ai', { prompt }); const jsonStr = aiRes.text.replace(/```json/g, "").replace(/```/g, "").trim(); const parsed = JSON.parse(jsonStr); await sendRequest('save_record', { date: document.getElementById('mDate').value, name: parsed.name, type: parsed.type, text: parsed.text.replace(/['"]/g, "").replace(/\*\*/g, ""), check: "ì—†ìŒ" }); showToast(`[${parsed.name}] ì €ì¥ ì™„ë£Œ`); document.getElementById('mInput').value = ""; } catch (e) { showToast("AI ì‹¤íŒ¨"); } clearLoading(btn); }
    </script>
</body>
</html>
